<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>vite核心原理 | sunnyxujian&#39;s blog</title>
    <meta name="generator" content="VuePress 1.8.0">
    <link rel="icon" href="/img/favicon1.ico">
    <meta name="description" content="web前端技术博客,专注web前端学习与总结。JavaScript,js,ES6,TypeScript,vue,react,css3,html5,Node,git,github等技术文章。">
    <meta name="keywords" content="前端博客,个人技术博客,前端,前端开发,前端框架,web前端,前端面试题,技术文档,学习,面试,JavaScript,js,ES6,TypeScript,vue,python,css3,html5,Node,git,github,markdown">
    <meta name="baidu-site-verification" content="7F55weZDDc">
    <meta name="theme-color" content="#4fc08d">
    <link rel="preload" href="/assets/css/0.styles.280b48f2.css" as="style"><link rel="preload" href="/assets/js/app.d76a6140.js" as="script"><link rel="preload" href="/assets/js/3.724bf448.js" as="script"><link rel="preload" href="/assets/js/5.f79ce4cb.js" as="script"><link rel="preload" href="/assets/js/87.66be9b4e.js" as="script"><link rel="prefetch" href="/assets/js/10.33e63f5b.js"><link rel="prefetch" href="/assets/js/100.88170c76.js"><link rel="prefetch" href="/assets/js/101.8d54c91e.js"><link rel="prefetch" href="/assets/js/102.7dff272c.js"><link rel="prefetch" href="/assets/js/103.b5f8461b.js"><link rel="prefetch" href="/assets/js/104.a6516759.js"><link rel="prefetch" href="/assets/js/105.ad5b08fd.js"><link rel="prefetch" href="/assets/js/106.157581cd.js"><link rel="prefetch" href="/assets/js/107.68e05ec4.js"><link rel="prefetch" href="/assets/js/108.76688ddd.js"><link rel="prefetch" href="/assets/js/109.73504a9d.js"><link rel="prefetch" href="/assets/js/11.0de4544b.js"><link rel="prefetch" href="/assets/js/110.289cecf3.js"><link rel="prefetch" href="/assets/js/111.2229d3c3.js"><link rel="prefetch" href="/assets/js/112.b63d71e6.js"><link rel="prefetch" href="/assets/js/113.1b781191.js"><link rel="prefetch" href="/assets/js/114.8d59c3f9.js"><link rel="prefetch" href="/assets/js/115.8e3070e3.js"><link rel="prefetch" href="/assets/js/116.e94d9ee8.js"><link rel="prefetch" href="/assets/js/117.e1ebdb1a.js"><link rel="prefetch" href="/assets/js/118.92597187.js"><link rel="prefetch" href="/assets/js/119.02881f9b.js"><link rel="prefetch" href="/assets/js/12.056774d7.js"><link rel="prefetch" href="/assets/js/120.f7f95b51.js"><link rel="prefetch" href="/assets/js/121.d87b90ad.js"><link rel="prefetch" href="/assets/js/122.8e81d12f.js"><link rel="prefetch" href="/assets/js/123.d1c5d272.js"><link rel="prefetch" href="/assets/js/124.071d3876.js"><link rel="prefetch" href="/assets/js/125.8da325b6.js"><link rel="prefetch" href="/assets/js/126.f3fac94a.js"><link rel="prefetch" href="/assets/js/127.705b0231.js"><link rel="prefetch" href="/assets/js/128.2d0cce43.js"><link rel="prefetch" href="/assets/js/129.136c9093.js"><link rel="prefetch" href="/assets/js/13.c41460b7.js"><link rel="prefetch" href="/assets/js/130.e273b0cd.js"><link rel="prefetch" href="/assets/js/131.1cdc1f03.js"><link rel="prefetch" href="/assets/js/132.e825fb82.js"><link rel="prefetch" href="/assets/js/133.0d293ef7.js"><link rel="prefetch" href="/assets/js/134.a0d635b9.js"><link rel="prefetch" href="/assets/js/135.1af5e654.js"><link rel="prefetch" href="/assets/js/136.bd4c2e25.js"><link rel="prefetch" href="/assets/js/137.e7d9d057.js"><link rel="prefetch" href="/assets/js/138.b2c4087c.js"><link rel="prefetch" href="/assets/js/139.9d81cea3.js"><link rel="prefetch" href="/assets/js/14.6f0de051.js"><link rel="prefetch" href="/assets/js/140.462f2f68.js"><link rel="prefetch" href="/assets/js/141.bfd924b2.js"><link rel="prefetch" href="/assets/js/142.f02c9f6c.js"><link rel="prefetch" href="/assets/js/143.3f153586.js"><link rel="prefetch" href="/assets/js/144.bba01f15.js"><link rel="prefetch" href="/assets/js/145.e6a25735.js"><link rel="prefetch" href="/assets/js/146.cd93e9ca.js"><link rel="prefetch" href="/assets/js/147.63f46f4b.js"><link rel="prefetch" href="/assets/js/148.138380f5.js"><link rel="prefetch" href="/assets/js/149.3980b184.js"><link rel="prefetch" href="/assets/js/15.60153c2f.js"><link rel="prefetch" href="/assets/js/150.7e8cb34a.js"><link rel="prefetch" href="/assets/js/151.559be224.js"><link rel="prefetch" href="/assets/js/152.a51c57fb.js"><link rel="prefetch" href="/assets/js/153.887a69dd.js"><link rel="prefetch" href="/assets/js/154.76aed2e7.js"><link rel="prefetch" href="/assets/js/155.5843b58d.js"><link rel="prefetch" href="/assets/js/156.9b68b27b.js"><link rel="prefetch" href="/assets/js/157.c79c5fef.js"><link rel="prefetch" href="/assets/js/158.3e7d2e05.js"><link rel="prefetch" href="/assets/js/159.ed6b9d8b.js"><link rel="prefetch" href="/assets/js/16.82dd19ed.js"><link rel="prefetch" href="/assets/js/160.37259815.js"><link rel="prefetch" href="/assets/js/161.7a48a04c.js"><link rel="prefetch" href="/assets/js/162.ffd40c22.js"><link rel="prefetch" href="/assets/js/163.eaf5d0ee.js"><link rel="prefetch" href="/assets/js/164.e5353a66.js"><link rel="prefetch" href="/assets/js/165.fe4a33a5.js"><link rel="prefetch" href="/assets/js/166.eb2a137a.js"><link rel="prefetch" href="/assets/js/167.d209e1d2.js"><link rel="prefetch" href="/assets/js/168.e1d97e56.js"><link rel="prefetch" href="/assets/js/169.c96bc779.js"><link rel="prefetch" href="/assets/js/17.c33de90a.js"><link rel="prefetch" href="/assets/js/170.53428bf5.js"><link rel="prefetch" href="/assets/js/171.685b798b.js"><link rel="prefetch" href="/assets/js/172.8127d652.js"><link rel="prefetch" href="/assets/js/173.f63942d1.js"><link rel="prefetch" href="/assets/js/174.7aaff485.js"><link rel="prefetch" href="/assets/js/175.411e5ac1.js"><link rel="prefetch" href="/assets/js/176.e65c95bb.js"><link rel="prefetch" href="/assets/js/177.90e620f4.js"><link rel="prefetch" href="/assets/js/178.d4ea1cdd.js"><link rel="prefetch" href="/assets/js/179.01df97a3.js"><link rel="prefetch" href="/assets/js/18.456e4218.js"><link rel="prefetch" href="/assets/js/180.0f5cda26.js"><link rel="prefetch" href="/assets/js/181.d3f6c371.js"><link rel="prefetch" href="/assets/js/182.18df4323.js"><link rel="prefetch" href="/assets/js/183.ce19b32c.js"><link rel="prefetch" href="/assets/js/184.780c19d0.js"><link rel="prefetch" href="/assets/js/185.8571a197.js"><link rel="prefetch" href="/assets/js/186.716b43aa.js"><link rel="prefetch" href="/assets/js/187.6acda53b.js"><link rel="prefetch" href="/assets/js/188.9460ea0f.js"><link rel="prefetch" href="/assets/js/189.f69905c1.js"><link rel="prefetch" href="/assets/js/19.1223b684.js"><link rel="prefetch" href="/assets/js/190.d0fb2193.js"><link rel="prefetch" href="/assets/js/191.dd8d7bea.js"><link rel="prefetch" href="/assets/js/192.e7ab2686.js"><link rel="prefetch" href="/assets/js/193.e1aef55c.js"><link rel="prefetch" href="/assets/js/194.790d107b.js"><link rel="prefetch" href="/assets/js/195.ce213cdb.js"><link rel="prefetch" href="/assets/js/196.d8e7ce65.js"><link rel="prefetch" href="/assets/js/197.6ca159ed.js"><link rel="prefetch" href="/assets/js/198.1f9103bf.js"><link rel="prefetch" href="/assets/js/199.647fab7d.js"><link rel="prefetch" href="/assets/js/2.900ae423.js"><link rel="prefetch" href="/assets/js/20.bc706733.js"><link rel="prefetch" href="/assets/js/200.5c297a04.js"><link rel="prefetch" href="/assets/js/201.b860990a.js"><link rel="prefetch" href="/assets/js/202.a2dee90c.js"><link rel="prefetch" href="/assets/js/203.6df560c4.js"><link rel="prefetch" href="/assets/js/204.ba95b5a5.js"><link rel="prefetch" href="/assets/js/205.8878cde9.js"><link rel="prefetch" href="/assets/js/206.cf365d5c.js"><link rel="prefetch" href="/assets/js/207.1265f6f6.js"><link rel="prefetch" href="/assets/js/208.d3292fda.js"><link rel="prefetch" href="/assets/js/209.31ad945b.js"><link rel="prefetch" href="/assets/js/21.d5b15a9e.js"><link rel="prefetch" href="/assets/js/210.d4095a65.js"><link rel="prefetch" href="/assets/js/211.da7e7f0b.js"><link rel="prefetch" href="/assets/js/212.86ffee1c.js"><link rel="prefetch" href="/assets/js/213.fc14f988.js"><link rel="prefetch" href="/assets/js/214.276b3100.js"><link rel="prefetch" href="/assets/js/215.977e7988.js"><link rel="prefetch" href="/assets/js/216.245b5975.js"><link rel="prefetch" href="/assets/js/217.e36d5149.js"><link rel="prefetch" href="/assets/js/218.f7b84d56.js"><link rel="prefetch" href="/assets/js/219.b17c2d18.js"><link rel="prefetch" href="/assets/js/22.305d3e0e.js"><link rel="prefetch" href="/assets/js/220.89978bee.js"><link rel="prefetch" href="/assets/js/221.94e9bc2b.js"><link rel="prefetch" href="/assets/js/222.d509002e.js"><link rel="prefetch" href="/assets/js/223.7d5329ab.js"><link rel="prefetch" href="/assets/js/224.d1efb469.js"><link rel="prefetch" href="/assets/js/225.068d1edc.js"><link rel="prefetch" href="/assets/js/226.203df552.js"><link rel="prefetch" href="/assets/js/227.ee66205e.js"><link rel="prefetch" href="/assets/js/228.611dcfa5.js"><link rel="prefetch" href="/assets/js/229.4570cebd.js"><link rel="prefetch" href="/assets/js/23.93f0d1ba.js"><link rel="prefetch" href="/assets/js/230.479fc52e.js"><link rel="prefetch" href="/assets/js/231.ac2939f8.js"><link rel="prefetch" href="/assets/js/232.1b593957.js"><link rel="prefetch" href="/assets/js/233.ed19c07d.js"><link rel="prefetch" href="/assets/js/234.1b8860c5.js"><link rel="prefetch" href="/assets/js/235.099f8d57.js"><link rel="prefetch" href="/assets/js/236.0f2e2794.js"><link rel="prefetch" href="/assets/js/237.c24a3987.js"><link rel="prefetch" href="/assets/js/238.24a8c123.js"><link rel="prefetch" href="/assets/js/239.ebbedd8a.js"><link rel="prefetch" href="/assets/js/24.65c88cda.js"><link rel="prefetch" href="/assets/js/240.61aa403a.js"><link rel="prefetch" href="/assets/js/241.40ae6a14.js"><link rel="prefetch" href="/assets/js/242.37049d18.js"><link rel="prefetch" href="/assets/js/243.8f6dabc9.js"><link rel="prefetch" href="/assets/js/244.00bcd6ce.js"><link rel="prefetch" href="/assets/js/245.2809b552.js"><link rel="prefetch" href="/assets/js/246.8b267a20.js"><link rel="prefetch" href="/assets/js/247.a67df8ec.js"><link rel="prefetch" href="/assets/js/248.4f26a33a.js"><link rel="prefetch" href="/assets/js/249.20bcad31.js"><link rel="prefetch" href="/assets/js/25.a1faceee.js"><link rel="prefetch" href="/assets/js/250.99917a60.js"><link rel="prefetch" href="/assets/js/251.bd763793.js"><link rel="prefetch" href="/assets/js/252.d301841d.js"><link rel="prefetch" href="/assets/js/253.8adc730c.js"><link rel="prefetch" href="/assets/js/254.7696fae3.js"><link rel="prefetch" href="/assets/js/255.dc87c295.js"><link rel="prefetch" href="/assets/js/256.b904c661.js"><link rel="prefetch" href="/assets/js/257.a6a4fd25.js"><link rel="prefetch" href="/assets/js/258.33e5aa35.js"><link rel="prefetch" href="/assets/js/259.412ed2c7.js"><link rel="prefetch" href="/assets/js/26.7af4b05a.js"><link rel="prefetch" href="/assets/js/260.52ff3c31.js"><link rel="prefetch" href="/assets/js/261.c2337769.js"><link rel="prefetch" href="/assets/js/262.0d9bfa34.js"><link rel="prefetch" href="/assets/js/263.c8e4cb6a.js"><link rel="prefetch" href="/assets/js/264.3464e615.js"><link rel="prefetch" href="/assets/js/265.5ef49004.js"><link rel="prefetch" href="/assets/js/27.d31fb32e.js"><link rel="prefetch" href="/assets/js/28.ac365b7a.js"><link rel="prefetch" href="/assets/js/29.4ec37ec1.js"><link rel="prefetch" href="/assets/js/30.8e31ec87.js"><link rel="prefetch" href="/assets/js/31.dbca7833.js"><link rel="prefetch" href="/assets/js/32.13f17495.js"><link rel="prefetch" href="/assets/js/33.84403c7c.js"><link rel="prefetch" href="/assets/js/34.ee01958a.js"><link rel="prefetch" href="/assets/js/35.ee834016.js"><link rel="prefetch" href="/assets/js/36.b27e2b58.js"><link rel="prefetch" href="/assets/js/37.5b9c6529.js"><link rel="prefetch" href="/assets/js/38.571abebc.js"><link rel="prefetch" href="/assets/js/39.7faebe0b.js"><link rel="prefetch" href="/assets/js/4.0a0c1c0f.js"><link rel="prefetch" href="/assets/js/40.c06ef95a.js"><link rel="prefetch" href="/assets/js/41.b1778bfc.js"><link rel="prefetch" href="/assets/js/42.a11eb5b9.js"><link rel="prefetch" href="/assets/js/43.dd5a39d2.js"><link rel="prefetch" href="/assets/js/44.e8f62cfa.js"><link rel="prefetch" href="/assets/js/45.019de3b4.js"><link rel="prefetch" href="/assets/js/46.4313681f.js"><link rel="prefetch" href="/assets/js/47.06396028.js"><link rel="prefetch" href="/assets/js/48.e77c89dd.js"><link rel="prefetch" href="/assets/js/49.a888c246.js"><link rel="prefetch" href="/assets/js/50.c81fd93d.js"><link rel="prefetch" href="/assets/js/51.ae7996b0.js"><link rel="prefetch" href="/assets/js/52.6aab4af3.js"><link rel="prefetch" href="/assets/js/53.0bb5c447.js"><link rel="prefetch" href="/assets/js/54.5ba7adba.js"><link rel="prefetch" href="/assets/js/55.d75ad9b1.js"><link rel="prefetch" href="/assets/js/56.a223d4a4.js"><link rel="prefetch" href="/assets/js/57.070c3d14.js"><link rel="prefetch" href="/assets/js/58.c07df3db.js"><link rel="prefetch" href="/assets/js/59.d468a048.js"><link rel="prefetch" href="/assets/js/6.2b00e463.js"><link rel="prefetch" href="/assets/js/60.0859ac91.js"><link rel="prefetch" href="/assets/js/61.ae4b86ed.js"><link rel="prefetch" href="/assets/js/62.e2e00ad4.js"><link rel="prefetch" href="/assets/js/63.ac9ed636.js"><link rel="prefetch" href="/assets/js/64.64603c0c.js"><link rel="prefetch" href="/assets/js/65.74bb2cbb.js"><link rel="prefetch" href="/assets/js/66.1758262f.js"><link rel="prefetch" href="/assets/js/67.5a3aa8f7.js"><link rel="prefetch" href="/assets/js/68.1c081375.js"><link rel="prefetch" href="/assets/js/69.c21e60d5.js"><link rel="prefetch" href="/assets/js/7.31d17e0f.js"><link rel="prefetch" href="/assets/js/70.8a74bf36.js"><link rel="prefetch" href="/assets/js/71.4492ba25.js"><link rel="prefetch" href="/assets/js/72.3296747e.js"><link rel="prefetch" href="/assets/js/73.c2a46fbe.js"><link rel="prefetch" href="/assets/js/74.366bddf4.js"><link rel="prefetch" href="/assets/js/75.e98af08c.js"><link rel="prefetch" href="/assets/js/76.c00e2544.js"><link rel="prefetch" href="/assets/js/77.a150a751.js"><link rel="prefetch" href="/assets/js/78.f3f879f6.js"><link rel="prefetch" href="/assets/js/79.da538e82.js"><link rel="prefetch" href="/assets/js/8.eb90e2e3.js"><link rel="prefetch" href="/assets/js/80.b1c3e778.js"><link rel="prefetch" href="/assets/js/81.3ca1bc6d.js"><link rel="prefetch" href="/assets/js/82.ca162a19.js"><link rel="prefetch" href="/assets/js/83.813d84be.js"><link rel="prefetch" href="/assets/js/84.17e1691d.js"><link rel="prefetch" href="/assets/js/85.dd4423c7.js"><link rel="prefetch" href="/assets/js/86.b25fb906.js"><link rel="prefetch" href="/assets/js/88.eadaae8d.js"><link rel="prefetch" href="/assets/js/89.859e72b3.js"><link rel="prefetch" href="/assets/js/9.1d492be9.js"><link rel="prefetch" href="/assets/js/90.cfb6b7b9.js"><link rel="prefetch" href="/assets/js/91.e79aee5d.js"><link rel="prefetch" href="/assets/js/92.68903be5.js"><link rel="prefetch" href="/assets/js/93.60158657.js"><link rel="prefetch" href="/assets/js/94.d2105386.js"><link rel="prefetch" href="/assets/js/95.1c40abf7.js"><link rel="prefetch" href="/assets/js/96.97eb871e.js"><link rel="prefetch" href="/assets/js/97.787d5951.js"><link rel="prefetch" href="/assets/js/98.00721321.js"><link rel="prefetch" href="/assets/js/99.a689649e.js">
    <link rel="stylesheet" href="/assets/css/0.styles.280b48f2.css">
  </head>
  <body class="theme-mode-light">
    <div id="app" data-server-rendered="true"><div class="theme-container sidebar-open have-rightmenu have-body-img"><header class="navbar blur"><div title="目录" class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/img/favicon1.png" alt="sunnyxujian's blog" class="logo"> <span class="site-name can-hide">sunnyxujian's blog</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="前端基础" class="dropdown-title"><a href="/basic/" class="link-title">前端基础</a> <span class="title" style="display:none;">前端基础</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/prototype/" class="nav-link">JavaScript</a></li><li class="dropdown-item"><!----> <a href="/pages/shoucang/" class="nav-link">CSS</a></li><li class="dropdown-item"><!----> <a href="/pages/html/" class="nav-link">HTML和浏览器</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="框架" class="dropdown-title"><a href="/framework/" class="link-title">框架</a> <span class="title" style="display:none;">框架</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/vue/" class="nav-link">Vue</a></li><li class="dropdown-item"><!----> <a href="/pages/vue3/" class="nav-link">Vue3</a></li><li class="dropdown-item"><!----> <a href="/pages/react/" class="nav-link">React</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="工程化" class="dropdown-title"><a href="/engineering/" class="link-title">工程化</a> <span class="title" style="display:none;">工程化</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/engineering/modules/" class="nav-link">基础知识</a></li><li class="dropdown-item"><!----> <a href="/engineering/workflow/" class="nav-link">webpack</a></li><li class="dropdown-item"><!----> <a href="/engineering/rollup/" class="nav-link">rollup</a></li><li class="dropdown-item"><!----> <a href="/engineering/vite/" class="nav-link">vite</a></li><li class="dropdown-item"><!----> <a href="/engineering/betterConsole/" class="nav-link">其他</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="前端进阶" class="dropdown-title"><a href="/advanced/" class="link-title">前端进阶</a> <span class="title" style="display:none;">前端进阶</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/advanced/nodejs/" class="nav-link">Nodejs</a></li><li class="dropdown-item"><!----> <a href="/advanced/net/" class="nav-link">网络</a></li><li class="dropdown-item"><!----> <a href="/advanced/typescript/" class="nav-link">TypeScript</a></li><li class="dropdown-item"><!----> <a href="/advanced/codedesign/" class="nav-link">架构设计</a></li><li class="dropdown-item"><!----> <a href="/advanced/optimize/" class="nav-link">性能优化</a></li><li class="dropdown-item"><!----> <a href="/advanced/algorithms/" class="nav-link">数据结构和算法</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="学习笔记" class="dropdown-title"><a href="/notes/" class="link-title">学习笔记</a> <span class="title" style="display:none;">学习笔记</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/notes/javascript/" class="nav-link">JavaScript教程 笔记</a></li><li class="dropdown-item"><!----> <a href="/notes/es6/" class="nav-link">ES6 教程 笔记</a></li><li class="dropdown-item"><!----> <a href="/notes/typescript-axios/" class="nav-link">TypeScript 从零实现 axios</a></li><li class="dropdown-item"><!----> <a href="/notes/git/" class="nav-link">Git学习 笔记</a></li><li class="dropdown-item"><!----> <a href="/notes/render/" class="nav-link">渲染器原理</a></li><li class="dropdown-item"><!----> <a href="/notes/typeScript/" class="nav-link">TypeScript 笔记</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="其他技术" class="dropdown-title"><a href="/technology/" class="link-title">其他技术</a> <span class="title" style="display:none;">其他技术</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/techDocs/" class="nav-link">技术文档</a></li><li class="dropdown-item"><!----> <a href="/pages/githubUseage/" class="nav-link">GitHub技巧</a></li><li class="dropdown-item"><!----> <a href="/pages/41f87d890d0a02af/" class="nav-link">博客搭建</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="收藏" class="dropdown-title"><a href="/pages/techSite/" class="link-title">收藏</a> <span class="title" style="display:none;">收藏</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/techSite/" class="nav-link">网站</a></li><li class="dropdown-item"><!----> <a href="/pages/usefulSite/" class="nav-link">资源</a></li><li class="dropdown-item"><!----> <a href="/pages/vueSource/" class="nav-link">Vue资源</a></li><li class="dropdown-item"><!----> <a href="/archives/" class="nav-link">友情链接</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="索引" class="dropdown-title"><a href="/archives/" class="link-title">索引</a> <span class="title" style="display:none;">索引</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/" class="nav-link">分类</a></li><li class="dropdown-item"><!----> <a href="/tags/" class="nav-link">标签</a></li><li class="dropdown-item"><!----> <a href="/archives/" class="nav-link">归档</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="友链&amp;关于" class="dropdown-title"><a href="/friends/" class="link-title">友链&amp;关于</a> <span class="title" style="display:none;">友链&amp;关于</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/friends/" class="nav-link">友链</a></li><li class="dropdown-item"><!----> <a href="/about/" class="nav-link">关于</a></li></ul></div></div> <a href="https://github.com//sunnyxujian" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar" style="display:none;"><div class="blogger"><img src="https://xj-1253772569.file.myqcloud.com/img/mona-loading-default.gif"> <div class="blogger-info"><h3>xujian</h3> <span>劝君惜取少年时。</span></div></div> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="前端基础" class="dropdown-title"><a href="/basic/" class="link-title">前端基础</a> <span class="title" style="display:none;">前端基础</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/prototype/" class="nav-link">JavaScript</a></li><li class="dropdown-item"><!----> <a href="/pages/shoucang/" class="nav-link">CSS</a></li><li class="dropdown-item"><!----> <a href="/pages/html/" class="nav-link">HTML和浏览器</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="框架" class="dropdown-title"><a href="/framework/" class="link-title">框架</a> <span class="title" style="display:none;">框架</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/vue/" class="nav-link">Vue</a></li><li class="dropdown-item"><!----> <a href="/pages/vue3/" class="nav-link">Vue3</a></li><li class="dropdown-item"><!----> <a href="/pages/react/" class="nav-link">React</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="工程化" class="dropdown-title"><a href="/engineering/" class="link-title">工程化</a> <span class="title" style="display:none;">工程化</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/engineering/modules/" class="nav-link">基础知识</a></li><li class="dropdown-item"><!----> <a href="/engineering/workflow/" class="nav-link">webpack</a></li><li class="dropdown-item"><!----> <a href="/engineering/rollup/" class="nav-link">rollup</a></li><li class="dropdown-item"><!----> <a href="/engineering/vite/" class="nav-link">vite</a></li><li class="dropdown-item"><!----> <a href="/engineering/betterConsole/" class="nav-link">其他</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="前端进阶" class="dropdown-title"><a href="/advanced/" class="link-title">前端进阶</a> <span class="title" style="display:none;">前端进阶</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/advanced/nodejs/" class="nav-link">Nodejs</a></li><li class="dropdown-item"><!----> <a href="/advanced/net/" class="nav-link">网络</a></li><li class="dropdown-item"><!----> <a href="/advanced/typescript/" class="nav-link">TypeScript</a></li><li class="dropdown-item"><!----> <a href="/advanced/codedesign/" class="nav-link">架构设计</a></li><li class="dropdown-item"><!----> <a href="/advanced/optimize/" class="nav-link">性能优化</a></li><li class="dropdown-item"><!----> <a href="/advanced/algorithms/" class="nav-link">数据结构和算法</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="学习笔记" class="dropdown-title"><a href="/notes/" class="link-title">学习笔记</a> <span class="title" style="display:none;">学习笔记</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/notes/javascript/" class="nav-link">JavaScript教程 笔记</a></li><li class="dropdown-item"><!----> <a href="/notes/es6/" class="nav-link">ES6 教程 笔记</a></li><li class="dropdown-item"><!----> <a href="/notes/typescript-axios/" class="nav-link">TypeScript 从零实现 axios</a></li><li class="dropdown-item"><!----> <a href="/notes/git/" class="nav-link">Git学习 笔记</a></li><li class="dropdown-item"><!----> <a href="/notes/render/" class="nav-link">渲染器原理</a></li><li class="dropdown-item"><!----> <a href="/notes/typeScript/" class="nav-link">TypeScript 笔记</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="其他技术" class="dropdown-title"><a href="/technology/" class="link-title">其他技术</a> <span class="title" style="display:none;">其他技术</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/techDocs/" class="nav-link">技术文档</a></li><li class="dropdown-item"><!----> <a href="/pages/githubUseage/" class="nav-link">GitHub技巧</a></li><li class="dropdown-item"><!----> <a href="/pages/41f87d890d0a02af/" class="nav-link">博客搭建</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="收藏" class="dropdown-title"><a href="/pages/techSite/" class="link-title">收藏</a> <span class="title" style="display:none;">收藏</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/techSite/" class="nav-link">网站</a></li><li class="dropdown-item"><!----> <a href="/pages/usefulSite/" class="nav-link">资源</a></li><li class="dropdown-item"><!----> <a href="/pages/vueSource/" class="nav-link">Vue资源</a></li><li class="dropdown-item"><!----> <a href="/archives/" class="nav-link">友情链接</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="索引" class="dropdown-title"><a href="/archives/" class="link-title">索引</a> <span class="title" style="display:none;">索引</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/" class="nav-link">分类</a></li><li class="dropdown-item"><!----> <a href="/tags/" class="nav-link">标签</a></li><li class="dropdown-item"><!----> <a href="/archives/" class="nav-link">归档</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="友链&amp;关于" class="dropdown-title"><a href="/friends/" class="link-title">友链&amp;关于</a> <span class="title" style="display:none;">友链&amp;关于</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/friends/" class="nav-link">友链</a></li><li class="dropdown-item"><!----> <a href="/about/" class="nav-link">关于</a></li></ul></div></div> <a href="https://github.com//sunnyxujian" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>基础知识</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>webpack</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>rollup</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>vite</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/engineering/vite/" class="sidebar-link">vite基本用法和项目实践</a></li><li><a href="/pages/56bbdc/" class="sidebar-link">esbuild介绍</a></li><li><a href="/pages/c204b5/" aria-current="page" class="active sidebar-link">vite核心原理</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/pages/c204b5/#_1-依赖安装和依赖介绍" class="sidebar-link">1. 依赖安装和依赖介绍</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/pages/c204b5/#_1-1-依赖安装" class="sidebar-link">1.1 依赖安装</a></li><li class="sidebar-sub-header"><a href="/pages/c204b5/#_1-2-connect" class="sidebar-link">1.2 Connect</a></li><li class="sidebar-sub-header"><a href="/pages/c204b5/#_1-3-serve-static" class="sidebar-link">1.3 serve-static</a></li><li class="sidebar-sub-header"><a href="/pages/c204b5/#_1-4-es-module-lexer" class="sidebar-link">1.4 es-module-lexer</a></li><li class="sidebar-sub-header"><a href="/pages/c204b5/#_1-5-resolve" class="sidebar-link">1.5 resolve</a></li><li class="sidebar-sub-header"><a href="/pages/c204b5/#_1-6-fast-glob" class="sidebar-link">1.6 fast-glob</a></li><li class="sidebar-sub-header"><a href="/pages/c204b5/#_1-7-magic-string" class="sidebar-link">1.7 magic-string</a></li></ul></li><li class="sidebar-sub-header"><a href="/pages/c204b5/#_2-实现命令行" class="sidebar-link">2.实现命令行</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/pages/c204b5/#_2-1-package-json" class="sidebar-link">2.1 package.json</a></li><li class="sidebar-sub-header"><a href="/pages/c204b5/#_2-2-vite2-js" class="sidebar-link">2.2 vite2.js</a></li><li class="sidebar-sub-header"><a href="/pages/c204b5/#_2-3-cli-js" class="sidebar-link">2.3 cli.js</a></li></ul></li><li class="sidebar-sub-header"><a href="/pages/c204b5/#_3-实现http服务器" class="sidebar-link">3.实现http服务器</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/pages/c204b5/#_3-1-cli-js" class="sidebar-link">3.1 cli.js</a></li><li class="sidebar-sub-header"><a href="/pages/c204b5/#_3-2-server-index-js" class="sidebar-link">3.2 server\index.js</a></li></ul></li><li class="sidebar-sub-header"><a href="/pages/c204b5/#_4-实现静态文件中间件" class="sidebar-link">4.实现静态文件中间件</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/pages/c204b5/#_4-1-server-index-js" class="sidebar-link">4.1 server\index.js</a></li><li class="sidebar-sub-header"><a href="/pages/c204b5/#_4-2-static-js" class="sidebar-link">4.2 static.js</a></li><li class="sidebar-sub-header"><a href="/pages/c204b5/#_4-3-config-js" class="sidebar-link">4.3 config.js</a></li><li class="sidebar-sub-header"><a href="/pages/c204b5/#_4-4-utils-js" class="sidebar-link">4.4 utils.js</a></li><li class="sidebar-sub-header"><a href="/pages/c204b5/#_4-5-index-html" class="sidebar-link">4.5 index.html</a></li><li class="sidebar-sub-header"><a href="/pages/c204b5/#_4-6-main-js" class="sidebar-link">4.6 main.js</a></li></ul></li><li class="sidebar-sub-header"><a href="/pages/c204b5/#_5-分析第三方依赖" class="sidebar-link">5.分析第三方依赖</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/pages/c204b5/#_5-1-server-index-js" class="sidebar-link">5.1 server\index.js</a></li><li class="sidebar-sub-header"><a href="/pages/c204b5/#_5-2-optimizer-index-js" class="sidebar-link">5.2 optimizer\index.js</a></li><li class="sidebar-sub-header"><a href="/pages/c204b5/#_5-3-scan-js" class="sidebar-link">5.3 scan.js</a></li><li class="sidebar-sub-header"><a href="/pages/c204b5/#_5-4-esbuildscanplugin-js" class="sidebar-link">5.4 esbuildScanPlugin.js</a></li><li class="sidebar-sub-header"><a href="/pages/c204b5/#_5-5-plugincontainer-js" class="sidebar-link">5.5 pluginContainer.js</a></li><li class="sidebar-sub-header"><a href="/pages/c204b5/#_5-6-resolve-js" class="sidebar-link">5.6 resolve.js</a></li></ul></li><li class="sidebar-sub-header"><a href="/pages/c204b5/#_6-预编译并保存metadata" class="sidebar-link">6. 预编译并保存metadata</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/pages/c204b5/#_6-1-server-index-js" class="sidebar-link">6.1 server\index.js</a></li><li class="sidebar-sub-header"><a href="/pages/c204b5/#_6-2-lib-config-js" class="sidebar-link">6.2 lib\config.js</a></li><li class="sidebar-sub-header"><a href="/pages/c204b5/#_6-3-utils-js" class="sidebar-link">6.3 utils.js</a></li><li class="sidebar-sub-header"><a href="/pages/c204b5/#_6-4-optimizer-index-js" class="sidebar-link">6.4 optimizer\index.js</a></li></ul></li><li class="sidebar-sub-header"><a href="/pages/c204b5/#_7-修改导入路径" class="sidebar-link">7.修改导入路径</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/pages/c204b5/#_7-1-lib-server-index-js" class="sidebar-link">7.1 lib\server\index.js</a></li><li class="sidebar-sub-header"><a href="/pages/c204b5/#_7-2-transform-js" class="sidebar-link">7.2 transform.js</a></li><li class="sidebar-sub-header"><a href="/pages/c204b5/#_7-3-plugincontainer-js" class="sidebar-link">7.3 pluginContainer.js</a></li><li class="sidebar-sub-header"><a href="/pages/c204b5/#_7-4-utils-js" class="sidebar-link">7.4 utils.js</a></li><li class="sidebar-sub-header"><a href="/pages/c204b5/#_7-5-transformrequest-js" class="sidebar-link">7.5 transformRequest.js</a></li><li class="sidebar-sub-header"><a href="/pages/c204b5/#_7-6-send-js" class="sidebar-link">7.6 send.js</a></li><li class="sidebar-sub-header"><a href="/pages/c204b5/#_7-7-plugins-index-js" class="sidebar-link">7.7 plugins\index.js</a></li><li class="sidebar-sub-header"><a href="/pages/c204b5/#_7-8-importanalysis-js" class="sidebar-link">7.8 importAnalysis.js</a></li><li class="sidebar-sub-header"><a href="/pages/c204b5/#_7-9-prealias-js" class="sidebar-link">7.9 preAlias.js</a></li><li class="sidebar-sub-header"><a href="/pages/c204b5/#_7-10-lib-config-js" class="sidebar-link">7.10 lib\config.js</a></li></ul></li><li class="sidebar-sub-header"><a href="/pages/c204b5/#_8-支持vue插件" class="sidebar-link">8.支持vue插件</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/pages/c204b5/#_8-1-esbuilddepplugin-js" class="sidebar-link">8.1 esbuildDepPlugin.js</a></li><li class="sidebar-sub-header"><a href="/pages/c204b5/#_8-2-lib-plugins-index-js" class="sidebar-link">8.2 lib\plugins\index.js</a></li><li class="sidebar-sub-header"><a href="/pages/c204b5/#_8-3-lib-utils-js" class="sidebar-link">8.3 lib\utils.js</a></li><li class="sidebar-sub-header"><a href="/pages/c204b5/#_8-4-config-js" class="sidebar-link">8.4 config.js</a></li><li class="sidebar-sub-header"><a href="/pages/c204b5/#_8-5-index-html" class="sidebar-link">8.5 index.html</a></li><li class="sidebar-sub-header"><a href="/pages/c204b5/#_8-6-src-main-js" class="sidebar-link">8.6 src\main.js</a></li><li class="sidebar-sub-header"><a href="/pages/c204b5/#_8-7-src-app-vue" class="sidebar-link">8.7 src\App.vue</a></li><li class="sidebar-sub-header"><a href="/pages/c204b5/#_8-8-vue-js" class="sidebar-link">8.8 vue.js</a></li></ul></li><li class="sidebar-sub-header"><a href="/pages/c204b5/#_9-支持style" class="sidebar-link">9.支持style</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/pages/c204b5/#_9-1-config-js" class="sidebar-link">9.1 config.js</a></li><li class="sidebar-sub-header"><a href="/pages/c204b5/#_9-2-src-app-vue" class="sidebar-link">9.2 src\App.vue</a></li><li class="sidebar-sub-header"><a href="/pages/c204b5/#_9-3-vue-js" class="sidebar-link">9.3 vue.js</a></li></ul></li><li class="sidebar-sub-header"><a href="/pages/c204b5/#_10-支持环境变量" class="sidebar-link">10.支持环境变量</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/pages/c204b5/#_10-1-plugins-index-js" class="sidebar-link">10.1 plugins\index.js</a></li><li class="sidebar-sub-header"><a href="/pages/c204b5/#_10-2-define-js" class="sidebar-link">10.2 define.js</a></li><li class="sidebar-sub-header"><a href="/pages/c204b5/#_10-3-plugins-vue-js" class="sidebar-link">10.3 plugins\vue.js</a></li></ul></li><li class="sidebar-sub-header"><a href="/pages/c204b5/#_11-支持hmr" class="sidebar-link">11.支持HMR</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/pages/c204b5/#_11-1-server-index-js" class="sidebar-link">11.1 server\index.js</a></li><li class="sidebar-sub-header"><a href="/pages/c204b5/#_11-2-lib-server-ws-js" class="sidebar-link">11.2 lib\server\ws.js</a></li><li class="sidebar-sub-header"><a href="/pages/c204b5/#_11-3-hmr-js" class="sidebar-link">11.3 hmr.js</a></li><li class="sidebar-sub-header"><a href="/pages/c204b5/#_11-4-transformrequest-js" class="sidebar-link">11.4 transformRequest.js</a></li><li class="sidebar-sub-header"><a href="/pages/c204b5/#_11-5-modulegraph-js" class="sidebar-link">11.5 moduleGraph.js</a></li><li class="sidebar-sub-header"><a href="/pages/c204b5/#_11-6-importanalysis-js" class="sidebar-link">11.6 importAnalysis.js</a></li><li class="sidebar-sub-header"><a href="/pages/c204b5/#_11-7-index-html" class="sidebar-link">11.7 index.html</a></li><li class="sidebar-sub-header"><a href="/pages/c204b5/#_11-8-src-main-js" class="sidebar-link">11.8 src\main.js</a></li><li class="sidebar-sub-header"><a href="/pages/c204b5/#_11-9-src-render-js" class="sidebar-link">11.9 src\render.js</a></li><li class="sidebar-sub-header"><a href="/pages/c204b5/#_11-10-src-client-js" class="sidebar-link">11.10 src\client.js</a></li></ul></li></ul></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>其他</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <div><main class="page"><div class="theme-vdoing-wrapper "><div class="articleInfo-wrap" data-v-583ea4e9><div class="articleInfo" data-v-583ea4e9><ul class="breadcrumbs" data-v-583ea4e9><li data-v-583ea4e9><a href="/" title="首页" class="iconfont icon-home router-link-active" data-v-583ea4e9></a></li> <li data-v-583ea4e9><a href="/engineering" title="工程化-目录页" data-v-583ea4e9>工程化</a></li> <li data-v-583ea4e9><a href="/engineering/#vite" title="工程化#vite" data-v-583ea4e9>vite</a></li> <!----></ul> <div class="info" data-v-583ea4e9><div title="作者" class="author iconfont icon-touxiang" data-v-583ea4e9><a href="https://github.com/sunnyxujian" target="_blank" title="作者" class="beLink" data-v-583ea4e9>xujian</a></div> <div title="创建时间" class="date iconfont icon-riqi" data-v-583ea4e9><a href="javascript:;" data-v-583ea4e9>2022-05-22</a></div> <!----></div></div></div> <!----> <div class="content-wrapper"><div class="right-menu-wrapper"><div class="right-menu-margin"><div class="right-menu-content"></div></div></div> <h1><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAYAAAA7MK6iAAAAAXNSR0IArs4c6QAABKFJREFUSA3tVl1oFVcQnrMbrak3QUgkya1akpJYcrUtIqW1JvFBE9LiQ5v6JmJpolbMg32rVrhgoYK0QiMY6i9Y6EMaW5D+xFJaTYItIuK2Kr3+BJNwkxBj05sQY3b3nM6cs2dv9t7NT/vQJw/sndk5M/PNzJkzewGerP+pAmy+ON8lLzUJgA8ZYxYIYZmGYRnctDaWvJJAmTtfP1pvXsBCCPP8QFcCaRkZYACgDZFO4stNIcBCajEOlmmC9XpJ9bAGCaPaPmzPl32dvLSVu3BWCTQs0XQQ6g0DYgwLIoAZbBCdW/i+781o1VVlm/410mw4h06Y7bIPHNyWDyL4FHkX03Q8SrzNhZTZriieckWt7cL6MM85YcLpsi/7O9/iXFT6MswI0DmmpkSaJ0qLxFIm3+i1THHB3zmBH3PYx9CcykcLOeQVVa7QtdxTgQgEleX2AjHYfwA+2ddV77ruGoJUbhGDI09YSNXyMpUt5ylOzxgbUmtOp7NmbNt8v3arjTBfYELmLUV+M+nSawNNAUqpT3ClJWg5I3BLT+cGW/DXNGCa6tx1aakCGEigArTn4TDIPdrXXYKCZNrHLMCOEPvHBlLQ99s9eHB7EB6NTki73CVPQ2F5MSx/uRQixfmq7rK0wYD8w8E905bnPDfwoWs/rfv93NWN/ZfvwsLIU7A09gxECyISeGJkHAau98L97tuw7NXnoPyNF8FcYGLGKsOs0mN3OEyec9esGW/ZEl945dTP34wlR2FZVQWU1q0Cw8Tr7p+hgLLNL0FPxx/Q35mA8aEUrH6nCgwEl0tn7wUiZYJnNRh6DK4UH/k0lfyrsBKdPVv/AriGIQcEDQZ65LBAGe2Rzui9Ybjz7XUppz1/uKBbyVPGkN3ZAeC6hr0x7Nr38N5+EqkoOm17xpoqR9ohQF55ERSvr4Dkr3chNfC3DMzGJlNBElW8w9nsGQvhNGIzDkXzCg8cLK951xHsFBlTJspJNi3ZFIMF2AeDV3q8DNOB+YHi6QTrChDIWDBRi5U5f+ZMfJLu3ccrqxtdxk4SKH336LFxSmkqefwU5T8fhdSdQf9IVKD6aNiwI/hnmcAZ91isYMJIaCUCx9W098+LgruikeTqzqqxKPUwqJyCPJiyemVVZBOijDGjD38Os0jOiSPL1z3SPjXNANbiNPXAdzTfukjjuknNBbyz3nwgTd3AVFqUJ5hpHlq9MveLnWwttUfoygBmvVjuikxND3znrhsELnZk7k+OjIGxeNEkomyLVta0xxn+HZhjBc4YZ/AFjHjz9u3xRZl2BN4aq9nFwWh16IrQ1aHHEd3j1+4/dB9OtH4e29A2H1DyHQRmOSfQZ1Fy7MHBTGB6J/Djq6p3OxyO2cB+4Car7v/o3GXgfAkj23+x9ID1Teoamo/SXcbvSf2PX7Vc8DdCmE1vN9di+32P9/5YR3vLnhCVGUWBjEkr3yh4H8v9CzmsbdhzOKzsJKM90iFdaTMjRPhGVsakRvOaRidljo6H6G7j+ctrJpsP+4COhDIl0La2+FS4+5mlocBaXY5QnGZysIBYoeSsl5qQzrSj/cgNrfuEzlWBfwA+EjrZyWUvpAAAAABJRU5ErkJggg==">
          vite核心原理
        </h1> <!----> <div class="theme-vdoing-content content__default"><h2 id="_1-依赖安装和依赖介绍"><a href="#_1-依赖安装和依赖介绍" class="header-anchor">#</a> 1. 依赖安装和依赖介绍</h2> <h3 id="_1-1-依赖安装"><a href="#_1-1-依赖安装" class="header-anchor">#</a> 1.1 依赖安装</h3> <div class="language-js line-numbers-mode"><pre class="language-js"><code>npm install connect es<span class="token operator">-</span>module<span class="token operator">-</span>lexer resolve check<span class="token operator">-</span>is<span class="token operator">-</span>array esbuild fast<span class="token operator">-</span>glob fs<span class="token operator">-</span>extra serve<span class="token operator">-</span><span class="token keyword">static</span> magic<span class="token operator">-</span>string chokidar ws <span class="token operator">--</span>save
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h3 id="_1-2-connect"><a href="#_1-2-connect" class="header-anchor">#</a> 1.2 Connect</h3> <ul><li><a href="https://www.npmjs.com/package/connect" target="_blank" rel="noopener noreferrer">Connect<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>是一个框架，它使用被称为中间件的模块化组件，以可重用的方式实现web程序的逻辑</li> <li>在Connect中，中间件组件是一个函数，它拦截HTTP服务器提供的请求和响应，执行逻辑，然后，或者结束响应，或者把它传递给下一个中间件组件</li> <li>Connect用分配器把中间件<strong>连接</strong>在一起</li> <li>Express构建在Connect之上的更高层的框架</li></ul> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> connect <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'connect'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> http <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'http'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> middlewares <span class="token operator">=</span> <span class="token function">connect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
middlewares<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'middleware1'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
middlewares<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'middleware2'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
middlewares<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token string">'Hello from Connect!'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
http<span class="token punctuation">.</span><span class="token function">createServer</span><span class="token punctuation">(</span>middlewares<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// middleware1 , middleware2, 'Hello from Connect!'</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><div class="custom-block tip"><p class="custom-block-title">提示</p> <p>connect的功能不多, 代码十分精简, 下面代码演示其核心原理:</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">connect</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> middlewares <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token keyword">const</span> <span class="token function-variable function">handler</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> index <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> 
    <span class="token keyword">function</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      middlewares<span class="token punctuation">[</span>index<span class="token operator">++</span><span class="token punctuation">]</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  handler<span class="token punctuation">.</span><span class="token function-variable function">use</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">middleware</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    middlewares<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>middleware<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> handler<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div></div> <h3 id="_1-3-serve-static"><a href="#_1-3-serve-static" class="header-anchor">#</a> 1.3 serve-static</h3> <ul><li><a href="https://www.npmjs.com/package/serve-static" target="_blank" rel="noopener noreferrer">serve-static<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>是一个静态文件中中间件</li></ul> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> connect <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'connect'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token keyword">static</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'serve-static'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> http <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'http'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> middlewares <span class="token operator">=</span> <span class="token function">connect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
middlewares<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token keyword">static</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 使用静态服务中间件</span>
http<span class="token punctuation">.</span><span class="token function">createServer</span><span class="token punctuation">(</span>middlewares<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">3001</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h3 id="_1-4-es-module-lexer"><a href="#_1-4-es-module-lexer" class="header-anchor">#</a> 1.4 es-module-lexer</h3> <ul><li><a href="https://www.npmjs.com/package/es-module-lexer" target="_blank" rel="noopener noreferrer">es-module-lexer<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>是一个JS模块语法解析器</li></ul> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token punctuation">{</span> init<span class="token punctuation">,</span> parse <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'es-module-lexer'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">await</span> init<span class="token punctuation">;</span> <span class="token comment">// 先等初始化完成</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>imports<span class="token punctuation">,</span> exports<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">parse</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">import _ from 'lodash';\nexport var p = 5</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 解析源代码</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>imports<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 分析导入 =&gt; [{name: '_'}]</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>exports<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 分析导出 =&gt; ['p']</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h3 id="_1-5-resolve"><a href="#_1-5-resolve" class="header-anchor">#</a> 1.5 resolve</h3> <ul><li><a href="https://www.npmjs.com/package/es-module-lexer" target="_blank" rel="noopener noreferrer">es-module-lexer<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>实现了node的<code>require.resolve()</code>算法, 用于获取模块在硬盘上的绝对路径</li></ul> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> resolve <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'resolve'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> res <span class="token operator">=</span> resolve<span class="token punctuation">.</span><span class="token function">sync</span><span class="token punctuation">(</span><span class="token string">'check-is-array'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">basedir</span><span class="token operator">:</span> __dirname <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// c:\project\vitelearn\node_modules\check-is-array\index.js</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h3 id="_1-6-fast-glob"><a href="#_1-6-fast-glob" class="header-anchor">#</a> 1.6 fast-glob</h3> <ul><li><a href="https://www.npmjs.com/package/fast-glob" target="_blank" rel="noopener noreferrer">fast-glob<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>该包提供了一些方法，用于遍历文件系统，并根据<code>Unix Bash shell</code>使用的规则返回与指定模式的定义集匹配的路径名</li></ul> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> fg <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fast-glob'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> entries <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">fg</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'**/*.js'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>entries<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 获取某个目录下的所有文件, 返回数组字符串, 里面的元素是文件名</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h3 id="_1-7-magic-string"><a href="#_1-7-magic-string" class="header-anchor">#</a> 1.7 magic-string</h3> <ul><li><a href="https://www.npmjs.com/package/magic-string" target="_blank" rel="noopener noreferrer">magic-string<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>是一个用来操作字符串的工具库, webpack，rollup里面都用到了这个工具。</li></ul> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> MagicString <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'magic-string'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> ms <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MagicString</span><span class="token punctuation">(</span><span class="token string">'var age = 10'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
ms<span class="token punctuation">.</span><span class="token function">overwrite</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">12</span><span class="token punctuation">,</span> <span class="token string">'100'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>ms<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// var age = 100</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h2 id="_2-实现命令行"><a href="#_2-实现命令行" class="header-anchor">#</a> 2.实现命令行</h2> <h3 id="_2-1-package-json"><a href="#_2-1-package-json" class="header-anchor">#</a> 2.1 package.json</h3> <div class="language-json line-numbers-mode"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;bin&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;vite2&quot;</span><span class="token operator">:</span> <span class="token string">&quot;./bin/vite2.js&quot;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h3 id="_2-2-vite2-js"><a href="#_2-2-vite2-js" class="header-anchor">#</a> 2.2 vite2.js</h3> <p>bin\vite2.js</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token hashbang comment">#!/usr/bin/env node</span>
<span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../lib/cli'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h3 id="_2-3-cli-js"><a href="#_2-3-cli-js" class="header-anchor">#</a> 2.3 cli.js</h3> <p>lib\cli.js</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'vite2'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><div class="custom-block tip"><p class="custom-block-title">提示</p> <p>需要在命令行执行<code>node link</code>将bin里面的命令接到全局, 后面直接在命令行<code>vite2</code>即可执行bin里面的脚本</p></div> <h2 id="_3-实现http服务器"><a href="#_3-实现http服务器" class="header-anchor">#</a> 3.实现http服务器</h2> <h3 id="_3-1-cli-js"><a href="#_3-1-cli-js" class="header-anchor">#</a> 3.1 cli.js</h3> <p>lib\cli.js</p> <div class="language-diff line-numbers-mode"><pre class="language-diff"><code><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">let { createServer } = require('./server');
</span><span class="token prefix inserted">+</span><span class="token line">(async function () {
</span><span class="token prefix inserted">+</span><span class="token line">  const server = await createServer();
</span><span class="token prefix inserted">+</span><span class="token line">  server.listen(9999);
</span><span class="token prefix inserted">+</span><span class="token line">})();
</span></span></code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h3 id="_3-2-server-index-js"><a href="#_3-2-server-index-js" class="header-anchor">#</a> 3.2 server\index.js</h3> <p>lib\server\index.js</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> connect <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'connect'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">createServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> middlewares <span class="token operator">=</span> <span class="token function">connect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 创建中间件</span>
  <span class="token keyword">const</span> server <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token keyword">async</span> <span class="token function">listen</span><span class="token punctuation">(</span><span class="token parameter">port</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'http'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">createServer</span><span class="token punctuation">(</span>middlewares<span class="token punctuation">)</span> <span class="token comment">// 使用中间件</span>
        <span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span>port<span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">dev server running at: http://localhost:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>port<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> server<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
exports<span class="token punctuation">.</span>createServer <span class="token operator">=</span> createServer<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><h2 id="_4-实现静态文件中间件"><a href="#_4-实现静态文件中间件" class="header-anchor">#</a> 4.实现静态文件中间件</h2> <h3 id="_4-1-server-index-js"><a href="#_4-1-server-index-js" class="header-anchor">#</a> 4.1 server\index.js</h3> <p>lib\server\index.js</p> <div class="language-diff line-numbers-mode"><pre class="language-diff"><code>const connect = require('connect');
<span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">const serveStaticMiddleware = require('./middlewares/static'); // 使用静态服务中间件
</span><span class="token prefix inserted">+</span><span class="token line">const resolveConfig = require('../config');
</span></span>async function createServer() {
<span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line"> const config = await resolveConfig()
</span></span><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line"> const middlewares = connect();
</span><span class="token prefix unchanged"> </span><span class="token line"> const server = {
</span><span class="token prefix unchanged"> </span><span class="token line">   async listen(port) {
</span><span class="token prefix unchanged"> </span><span class="token line">     require('http').createServer(middlewares)
</span><span class="token prefix unchanged"> </span><span class="token line">       .listen(port, async () =&gt; {
</span><span class="token prefix unchanged"> </span><span class="token line">         console.log(`dev server running at: http://localhost:${port}`)
</span><span class="token prefix unchanged"> </span><span class="token line">       })
</span><span class="token prefix unchanged"> </span><span class="token line">   }
</span><span class="token prefix unchanged"> </span><span class="token line"> }
</span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line"> middlewares.use(serveStaticMiddleware(config))
</span></span><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line"> return server;
</span></span>}
exports.createServer = createServer;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><h3 id="_4-2-static-js"><a href="#_4-2-static-js" class="header-anchor">#</a> 4.2 static.js</h3> <p>lib\server\middlewares\static.js</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token keyword">static</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'serve-static'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">function</span> <span class="token function">serveStaticMiddleware</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> root <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">static</span><span class="token punctuation">(</span>root<span class="token punctuation">)</span> <span class="token comment">// 创建http静态服务</span>
<span class="token punctuation">}</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> serveStaticMiddleware<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h3 id="_4-3-config-js"><a href="#_4-3-config-js" class="header-anchor">#</a> 4.3 config.js</h3> <p>lib\config.js</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token punctuation">{</span> normalizePath <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./utils'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">resolveConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> root <span class="token operator">=</span> <span class="token function">normalizePath</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span><span class="token function">cwd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 获取当前命令执行的绝对路径</span>
  <span class="token keyword">let</span> config <span class="token operator">=</span> <span class="token punctuation">{</span>
    root
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> config<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> resolveConfig<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><h3 id="_4-4-utils-js"><a href="#_4-4-utils-js" class="header-anchor">#</a> 4.4 utils.js</h3> <p>lib\utils.js</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">normalizePath</span><span class="token punctuation">(</span><span class="token parameter">id</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> id<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\\</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">,</span> <span class="token string">'/'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
exports<span class="token punctuation">.</span>normalizePath <span class="token operator">=</span> normalizePath<span class="token punctuation">;</span> <span class="token comment">// 将所有的`\\`转成`/`</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h3 id="_4-5-index-html"><a href="#_4-5-index-html" class="header-anchor">#</a> 4.5 index.html</h3> <p>index.html</p> <div class="language-html line-numbers-mode"><pre class="language-html"><code><span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">html</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>en<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>UTF-8<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">http-equiv</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>X-UA-Compatible<span class="token punctuation">&quot;</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>IE=edge<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>viewport<span class="token punctuation">&quot;</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>width=device-width, initial-scale=1.0<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">&gt;</span></span>vite2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>app<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>/src/main.js<span class="token punctuation">&quot;</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>module<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><h3 id="_4-6-main-js"><a href="#_4-6-main-js" class="header-anchor">#</a> 4.6 main.js</h3> <p>src\main.js</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'main'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h2 id="_5-分析第三方依赖"><a href="#_5-分析第三方依赖" class="header-anchor">#</a> 5.分析第三方依赖</h2> <h3 id="_5-1-server-index-js"><a href="#_5-1-server-index-js" class="header-anchor">#</a> 5.1 server\index.js</h3> <p>lib\server\index.js</p> <div class="language-diff line-numbers-mode"><pre class="language-diff"><code>const connect = require('connect');
const serveStaticMiddleware = require('./middlewares/static');
const resolveConfig = require('../config');
<span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">const { createOptimizeDepsRun } = require('../optimizer');
</span></span>async function createServer() {
<span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line"> const config = await resolveConfig()
</span><span class="token prefix unchanged"> </span><span class="token line"> const middlewares = connect();
</span><span class="token prefix unchanged"> </span><span class="token line"> const server = {
</span><span class="token prefix unchanged"> </span><span class="token line">   async listen(port) {
</span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">     await runOptimize(config, server)
</span></span><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">     require('http').createServer(middlewares)
</span><span class="token prefix unchanged"> </span><span class="token line">       .listen(port, async () =&gt; {
</span><span class="token prefix unchanged"> </span><span class="token line">         console.log(`dev server running at: http://localhost:${port}`)
</span><span class="token prefix unchanged"> </span><span class="token line">       })
</span><span class="token prefix unchanged"> </span><span class="token line">   }
</span><span class="token prefix unchanged"> </span><span class="token line"> }
</span><span class="token prefix unchanged"> </span><span class="token line"> middlewares.use(serveStaticMiddleware(config))
</span><span class="token prefix unchanged"> </span><span class="token line"> return server;
</span></span>}
<span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">async function runOptimize(config, server) {
</span><span class="token prefix inserted">+</span><span class="token line">  await createOptimizeDepsRun(config)
</span><span class="token prefix inserted">+</span><span class="token line">}
</span></span>exports.createServer = createServer;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><h3 id="_5-2-optimizer-index-js"><a href="#_5-2-optimizer-index-js" class="header-anchor">#</a> 5.2 optimizer\index.js</h3> <p>lib\optimizer\index.js</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> scanImports <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./scan'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">createOptimizeDepsRun</span><span class="token punctuation">(</span><span class="token parameter">config</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> deps <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">scanImports</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>deps<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
exports<span class="token punctuation">.</span>createOptimizeDepsRun <span class="token operator">=</span> createOptimizeDepsRun<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h3 id="_5-3-scan-js"><a href="#_5-3-scan-js" class="header-anchor">#</a> 5.3 scan.js</h3> <p>lib\optimizer\scan.js</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token punctuation">{</span> build <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'esbuild'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> esbuildScanPlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./esbuildScanPlugin'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">scanImports</span><span class="token punctuation">(</span><span class="token parameter">config</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> depImports <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> esPlugin <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">esbuildScanPlugin</span><span class="token punctuation">(</span>config<span class="token punctuation">,</span> depImports<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">await</span> <span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token literal-property property">absWorkingDir</span><span class="token operator">:</span> config<span class="token punctuation">.</span>root<span class="token punctuation">,</span>
    <span class="token literal-property property">entryPoints</span><span class="token operator">:</span> <span class="token punctuation">[</span>path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'./index.html'</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token literal-property property">bundle</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token literal-property property">format</span><span class="token operator">:</span> <span class="token string">'esm'</span><span class="token punctuation">,</span>
    <span class="token literal-property property">outfile</span><span class="token operator">:</span> <span class="token string">'dist/index.js'</span><span class="token punctuation">,</span>
    <span class="token literal-property property">write</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token literal-property property">plugins</span><span class="token operator">:</span> <span class="token punctuation">[</span>esPlugin<span class="token punctuation">]</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token keyword">return</span> depImports<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> scanImports<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><h3 id="_5-4-esbuildscanplugin-js"><a href="#_5-4-esbuildscanplugin-js" class="header-anchor">#</a> 5.4 esbuildScanPlugin.js</h3> <p>lib\optimizer\esbuildScanPlugin.js</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs-extra'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> createPluginContainer <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../server/pluginContainer'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> resolvePlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../plugins/resolve'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> normalizePath <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../utils'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> htmlTypesRE <span class="token operator">=</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\.html$</span><span class="token regex-delimiter">/</span></span>
<span class="token keyword">const</span> scriptModuleRE <span class="token operator">=</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">&lt;script src\=&quot;(.+?)&quot; type=&quot;module&quot;&gt;&lt;\/script&gt;</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token constant">JS_TYPES_RE</span> <span class="token operator">=</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\.js$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">;</span>
<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">esbuildScanPlugin</span><span class="token punctuation">(</span><span class="token parameter">config<span class="token punctuation">,</span> depImports</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  config<span class="token punctuation">.</span>plugins <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token function">resolvePlugin</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> container <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">createPluginContainer</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>
  <span class="token keyword">const</span> <span class="token function-variable function">resolve</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">id<span class="token punctuation">,</span> importer</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">await</span> container<span class="token punctuation">.</span><span class="token function">resolveId</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> importer<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'vite:dep-scan'</span><span class="token punctuation">,</span>
    <span class="token function">setup</span><span class="token punctuation">(</span><span class="token parameter">build</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      build<span class="token punctuation">.</span><span class="token function">onResolve</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">filter</span><span class="token operator">:</span> htmlTypesRE <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> path<span class="token punctuation">,</span> importer <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> resolved <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">resolve</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> importer<span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>resolved<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">return</span> <span class="token punctuation">{</span>
            <span class="token literal-property property">path</span><span class="token operator">:</span> resolved<span class="token punctuation">.</span>id <span class="token operator">||</span> resolved<span class="token punctuation">,</span>
            <span class="token literal-property property">namespace</span><span class="token operator">:</span> <span class="token string">'html'</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
      build<span class="token punctuation">.</span><span class="token function">onResolve</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">filter</span><span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">.*</span><span class="token regex-delimiter">/</span></span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> path<span class="token punctuation">,</span> importer <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> resolved <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">resolve</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> importer<span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>resolved<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">const</span> id <span class="token operator">=</span> resolved<span class="token punctuation">.</span>id <span class="token operator">||</span> resolved<span class="token punctuation">;</span>
          <span class="token keyword">const</span> included <span class="token operator">=</span> id<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span><span class="token string">'node_modules'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>included<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            depImports<span class="token punctuation">[</span>path<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">normalizePath</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token punctuation">{</span>
              <span class="token literal-property property">path</span><span class="token operator">:</span> id<span class="token punctuation">,</span>
              <span class="token literal-property property">external</span><span class="token operator">:</span> <span class="token boolean">true</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span>
          <span class="token keyword">return</span> <span class="token punctuation">{</span>
            <span class="token literal-property property">path</span><span class="token operator">:</span> id
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token punctuation">{</span> path <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
      build<span class="token punctuation">.</span><span class="token function">onLoad</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">filter</span><span class="token operator">:</span> htmlTypesRE<span class="token punctuation">,</span> <span class="token literal-property property">namespace</span><span class="token operator">:</span> <span class="token string">'html'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> path <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> html <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> <span class="token string">'utf-8'</span><span class="token punctuation">)</span>
        <span class="token keyword">let</span> <span class="token punctuation">[</span><span class="token punctuation">,</span> scriptSrc<span class="token punctuation">]</span> <span class="token operator">=</span> html<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span>scriptModuleRE<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> js <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">import </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>scriptSrc<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">;\n</span><span class="token template-punctuation string">`</span></span>
        <span class="token keyword">return</span> <span class="token punctuation">{</span>
          <span class="token literal-property property">loader</span><span class="token operator">:</span> <span class="token string">'js'</span><span class="token punctuation">,</span>
          <span class="token literal-property property">contents</span><span class="token operator">:</span> js
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
      build<span class="token punctuation">.</span><span class="token function">onLoad</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">filter</span><span class="token operator">:</span> <span class="token constant">JS_TYPES_RE</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> <span class="token literal-property property">path</span><span class="token operator">:</span> id <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> ext <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">extname</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token keyword">let</span> contents <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> <span class="token string">'utf-8'</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token punctuation">{</span>
          <span class="token literal-property property">loader</span><span class="token operator">:</span> ext<span class="token punctuation">,</span>
          contents
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> esbuildScanPlugin<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br></div></div><h3 id="_5-5-plugincontainer-js"><a href="#_5-5-plugincontainer-js" class="header-anchor">#</a> 5.5 pluginContainer.js</h3> <p>lib\server\pluginContainer.js</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token punctuation">{</span> normalizePath <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;../utils&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">createPluginContainer</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> plugins<span class="token punctuation">,</span>root <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">class</span> <span class="token class-name">PluginContext</span> <span class="token punctuation">{</span>
    <span class="token keyword">async</span> <span class="token function">resolve</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> <span class="token punctuation">,</span> importer <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> <span class="token string">'index.html'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token keyword">await</span> container<span class="token punctuation">.</span><span class="token function">resolveId</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> importer<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">const</span> container <span class="token operator">=</span> <span class="token punctuation">{</span>
     <span class="token keyword">async</span> <span class="token function">resolveId</span><span class="token punctuation">(</span><span class="token parameter">id<span class="token punctuation">,</span> importer</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">let</span> ctx <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PluginContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> resolveId <span class="token operator">=</span> id<span class="token punctuation">;</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> plugin <span class="token keyword">of</span> plugins<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>plugin<span class="token punctuation">.</span>resolveId<span class="token punctuation">)</span> <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">await</span> plugin<span class="token punctuation">.</span><span class="token function">resolveId</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> id<span class="token punctuation">,</span> importer<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>result<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          resolveId <span class="token operator">=</span> result<span class="token punctuation">.</span>id <span class="token operator">||</span> result<span class="token punctuation">;</span>
          <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">return</span> <span class="token punctuation">{</span> <span class="token literal-property property">id</span><span class="token operator">:</span> <span class="token function">normalizePath</span><span class="token punctuation">(</span>resolveId<span class="token punctuation">)</span> <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> container<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
exports<span class="token punctuation">.</span>createPluginContainer <span class="token operator">=</span> createPluginContainer<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div><h3 id="_5-6-resolve-js"><a href="#_5-6-resolve-js" class="header-anchor">#</a> 5.6 resolve.js</h3> <p>lib\plugins\resolve.js</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> resolve <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'resolve'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">function</span> <span class="token function">resolvePlugin</span><span class="token punctuation">(</span><span class="token parameter">config</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'vite:resolve'</span><span class="token punctuation">,</span>
    <span class="token function">resolveId</span><span class="token punctuation">(</span><span class="token parameter">id<span class="token punctuation">,</span> importer</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">//如果/开头表示是绝对路径</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>id<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token punctuation">{</span> <span class="token literal-property property">id</span><span class="token operator">:</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>root<span class="token punctuation">,</span> id<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token comment">//如果是绝对路径</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">isAbsolute</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token punctuation">{</span> id <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      <span class="token comment">//如果是相对路径</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>id<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">'.'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> basedir <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">dirname</span><span class="token punctuation">(</span>importer<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">const</span> fsPath <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>basedir<span class="token punctuation">,</span> id<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token punctuation">{</span> <span class="token literal-property property">id</span><span class="token operator">:</span> fsPath <span class="token punctuation">}</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token comment">//如果是第三方包</span>
      <span class="token keyword">let</span> res <span class="token operator">=</span> <span class="token function">tryNodeResolve</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> importer<span class="token punctuation">,</span> config<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>res<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> res<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">tryNodeResolve</span><span class="token punctuation">(</span><span class="token parameter">id<span class="token punctuation">,</span> importer<span class="token punctuation">,</span> config</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> pkgPath <span class="token operator">=</span> resolve<span class="token punctuation">.</span><span class="token function">sync</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>id<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/package.json</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">basedir</span><span class="token operator">:</span> config<span class="token punctuation">.</span>root <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> pkgDir <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">dirname</span><span class="token punctuation">(</span>pkgPath<span class="token punctuation">)</span>
  <span class="token keyword">const</span> pkg <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>fs<span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">(</span>pkgPath<span class="token punctuation">,</span> <span class="token string">'utf-8'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> entryPoint <span class="token operator">=</span> pkg<span class="token punctuation">.</span>module
  <span class="token keyword">const</span> entryPointPath <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>pkgDir<span class="token punctuation">,</span> entryPoint<span class="token punctuation">)</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span> <span class="token literal-property property">id</span><span class="token operator">:</span> entryPointPath <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> resolvePlugin<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br></div></div><h2 id="_6-预编译并保存metadata"><a href="#_6-预编译并保存metadata" class="header-anchor">#</a> 6. 预编译并保存metadata</h2> <h3 id="_6-1-server-index-js"><a href="#_6-1-server-index-js" class="header-anchor">#</a> 6.1 server\index.js</h3> <p>lib\server\index.js</p> <div class="language-diff line-numbers-mode"><pre class="language-diff"><code>const connect = require('connect');
const http = require('http');
const serveStaticMiddleware = require('./middlewares/static');
const resolveConfig = require('../config');
const { createOptimizeDepsRun } = require('../optimizer');
async function createServer() {
<span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line"> const config = await resolveConfig();
</span><span class="token prefix unchanged"> </span><span class="token line"> const middlewares = connect();
</span><span class="token prefix unchanged"> </span><span class="token line"> const server = {
</span><span class="token prefix unchanged"> </span><span class="token line">   async listen(port) {
</span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">     await runOptimize(config, server)
</span></span><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">     http.createServer(middlewares).listen(port, async () =&gt; {
</span><span class="token prefix unchanged"> </span><span class="token line">       console.log(`server running at http://localhost:${port}`);
</span><span class="token prefix unchanged"> </span><span class="token line">     });
</span><span class="token prefix unchanged"> </span><span class="token line">   }
</span><span class="token prefix unchanged"> </span><span class="token line"> }
</span><span class="token prefix unchanged"> </span><span class="token line"> middlewares.use(serveStaticMiddleware(config));
</span><span class="token prefix unchanged"> </span><span class="token line"> return server;
</span></span>}
<span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">async function runOptimize(config, server) {
</span><span class="token prefix inserted">+</span><span class="token line">  const optimizeDeps = await createOptimizeDepsRun(config);
</span><span class="token prefix inserted">+</span><span class="token line">  server._optimizeDepsMetadata = optimizeDeps.metadata
</span></span>}
exports.createServer = createServer;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><h3 id="_6-2-lib-config-js"><a href="#_6-2-lib-config-js" class="header-anchor">#</a> 6.2 lib\config.js</h3> <p>lib\config.js</p> <div class="language-diff line-numbers-mode"><pre class="language-diff"><code><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">const path = require('path');
</span></span>const { normalizePath } = require('./utils');
async function resolveConfig() {
<span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line"> //当前的根目录 window \\  linux /
</span><span class="token prefix unchanged"> </span><span class="token line"> const root = normalizePath(process.cwd());
</span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line"> const cacheDir = normalizePath(path.resolve(`node_modules/.vite7`))
</span></span><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line"> let config = {
</span><span class="token prefix unchanged"> </span><span class="token line">   root,
</span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">   cacheDir
</span></span><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line"> }
</span><span class="token prefix unchanged"> </span><span class="token line"> return config;
</span></span>}
module.exports = resolveConfig;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><h3 id="_6-3-utils-js"><a href="#_6-3-utils-js" class="header-anchor">#</a> 6.3 utils.js</h3> <p>lib\utils.js</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">normalizePath</span><span class="token punctuation">(</span><span class="token parameter">id</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> id<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\\</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">,</span> <span class="token string">'/'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
exports<span class="token punctuation">.</span>normalizePath <span class="token operator">=</span> normalizePath<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h3 id="_6-4-optimizer-index-js"><a href="#_6-4-optimizer-index-js" class="header-anchor">#</a> 6.4 optimizer\index.js</h3> <p>lib\optimizer\index.js</p> <div class="language-diff line-numbers-mode"><pre class="language-diff"><code>const scanImports = require('./scan');
<span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">const fs = require('fs-extra');
</span><span class="token prefix inserted">+</span><span class="token line">const path = require('path');
</span><span class="token prefix inserted">+</span><span class="token line">const { build } = require('esbuild');
</span><span class="token prefix inserted">+</span><span class="token line">const { normalizePath } = require('../utils');
</span></span>async function createOptimizeDepsRun(config) {
<span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line"> const deps = await scanImports(config);
</span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line"> const { cacheDir } = config;
</span><span class="token prefix inserted">+</span><span class="token line"> const depsCacheDir = path.resolve(cacheDir, 'deps')
</span><span class="token prefix inserted">+</span><span class="token line"> const metadataPath = path.join(depsCacheDir, '_metadata.json');
</span><span class="token prefix inserted">+</span><span class="token line"> const metadata = {
</span><span class="token prefix inserted">+</span><span class="token line">   optimized: {}
</span><span class="token prefix inserted">+</span><span class="token line"> }
</span><span class="token prefix inserted">+</span><span class="token line"> for (const id in deps) {
</span><span class="token prefix inserted">+</span><span class="token line">   const entry = deps[id]
</span><span class="token prefix inserted">+</span><span class="token line">   metadata.optimized[id] = {
</span><span class="token prefix inserted">+</span><span class="token line">     file: normalizePath(path.resolve(depsCacheDir, id + '.js')),
</span><span class="token prefix inserted">+</span><span class="token line">     src: entry
</span><span class="token prefix inserted">+</span><span class="token line">   }
</span><span class="token prefix inserted">+</span><span class="token line">   await build({
</span><span class="token prefix inserted">+</span><span class="token line">     absWorkingDir: process.cwd(),
</span><span class="token prefix inserted">+</span><span class="token line">     entryPoints: [deps[id]],
</span><span class="token prefix inserted">+</span><span class="token line">     outfile: path.resolve(depsCacheDir, id + '.js'),
</span><span class="token prefix inserted">+</span><span class="token line">     bundle: true,
</span><span class="token prefix inserted">+</span><span class="token line">     write: true,
</span><span class="token prefix inserted">+</span><span class="token line">     format: 'esm'
</span><span class="token prefix inserted">+</span><span class="token line">   })
</span><span class="token prefix inserted">+</span><span class="token line"> }
</span><span class="token prefix inserted">+</span><span class="token line"> await fs.ensureDir(depsCacheDir);
</span><span class="token prefix inserted">+</span><span class="token line"> await fs.writeFile(metadataPath, JSON.stringify(metadata, (key, value) =&gt; {
</span><span class="token prefix inserted">+</span><span class="token line">   if (key === 'file' || key === 'src') {
</span><span class="token prefix inserted">+</span><span class="token line">     console.log(depsCacheDir, value);
</span><span class="token prefix inserted">+</span><span class="token line">     return normalizePath(path.relative(depsCacheDir, value));
</span><span class="token prefix inserted">+</span><span class="token line">   }
</span><span class="token prefix inserted">+</span><span class="token line">   return value
</span><span class="token prefix inserted">+</span><span class="token line"> }, 2));
</span><span class="token prefix inserted">+</span><span class="token line"> return { metadata };
</span></span>}
exports.createOptimizeDepsRun = createOptimizeDepsRun;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br></div></div><h2 id="_7-修改导入路径"><a href="#_7-修改导入路径" class="header-anchor">#</a> 7.修改导入路径</h2> <ul><li><code>import { createApp } from 'vue'</code></li> <li><code>import { createApp } from '/node_modules/.vite7/deps/vue.js'</code></li></ul> <h3 id="_7-1-lib-server-index-js"><a href="#_7-1-lib-server-index-js" class="header-anchor">#</a> 7.1 lib\server\index.js</h3> <p>lib\server\index.js</p> <div class="language-diff line-numbers-mode"><pre class="language-diff"><code>const connect = require('connect');
const http = require('http');
const serveStaticMiddleware = require('./middlewares/static');
const resolveConfig = require('../config');
const { createOptimizeDepsRun } = require('../optimizer');
<span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">const transformMiddleware = require('./middlewares/transform');
</span><span class="token prefix inserted">+</span><span class="token line">const { createPluginContainer } = require('./pluginContainer');
</span></span>async function createServer() {
<span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line"> const config = await resolveConfig();
</span><span class="token prefix unchanged"> </span><span class="token line"> const middlewares = connect();
</span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line"> const pluginContainer = await createPluginContainer(config)
</span></span><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line"> const server = {
</span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">   pluginContainer,
</span></span><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">   async listen(port) {
</span><span class="token prefix unchanged"> </span><span class="token line">     await runOptimize(config, server)
</span><span class="token prefix unchanged"> </span><span class="token line">     http.createServer(middlewares).listen(port, async () =&gt; {
</span><span class="token prefix unchanged"> </span><span class="token line">       console.log(`server running at http://localhost:${port}`);
</span><span class="token prefix unchanged"> </span><span class="token line">     });
</span><span class="token prefix unchanged"> </span><span class="token line">   }
</span><span class="token prefix unchanged"> </span><span class="token line"> }
</span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line"> for (const plugin of config.plugins) {
</span><span class="token prefix inserted">+</span><span class="token line">   if (plugin.configureServer) {
</span><span class="token prefix inserted">+</span><span class="token line">     await plugin.configureServer(server)
</span><span class="token prefix inserted">+</span><span class="token line">   }
</span><span class="token prefix inserted">+</span><span class="token line"> }
</span><span class="token prefix inserted">+</span><span class="token line"> middlewares.use(transformMiddleware(server))
</span></span><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line"> middlewares.use(serveStaticMiddleware(config));
</span><span class="token prefix unchanged"> </span><span class="token line"> return server;
</span></span>}
async function runOptimize(config, server) {
<span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line"> const optimizeDeps = await createOptimizeDepsRun(config);
</span><span class="token prefix unchanged"> </span><span class="token line"> server._optimizeDepsMetadata = optimizeDeps.metadata
</span></span>}
exports.createServer = createServer;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br></div></div><h3 id="_7-2-transform-js"><a href="#_7-2-transform-js" class="header-anchor">#</a> 7.2 transform.js</h3> <p>lib\server\middlewares\transform.js</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token punctuation">{</span> isJSRequest <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../../utils'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> send <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../send'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> transformRequest <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../transformRequest'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> parse <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'url'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">function</span> <span class="token function">transformMiddleware</span><span class="token punctuation">(</span><span class="token parameter">server</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>req<span class="token punctuation">.</span>method <span class="token operator">!==</span> <span class="token string">'GET'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">let</span> url <span class="token operator">=</span> <span class="token function">parse</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>url<span class="token punctuation">)</span><span class="token punctuation">.</span>pathname<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isJSRequest</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">transformRequest</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> server<span class="token punctuation">)</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>result<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> type <span class="token operator">=</span> <span class="token string">'js'</span>
        <span class="token keyword">return</span> <span class="token function">send</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> result<span class="token punctuation">.</span>code<span class="token punctuation">,</span> type<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> transformMiddleware
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><h3 id="_7-3-plugincontainer-js"><a href="#_7-3-plugincontainer-js" class="header-anchor">#</a> 7.3 pluginContainer.js</h3> <p>lib\server\pluginContainer.js</p> <div class="language-diff line-numbers-mode"><pre class="language-diff"><code>const { normalizePath } = require(&quot;../utils&quot;);
const path = require('path');
async function createPluginContainer({ plugins,root }) {
<span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line"> class PluginContext {
</span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">   async resolve(id, importer= path.join(root, 'index.html')) {
</span><span class="token prefix inserted">+</span><span class="token line">     return await container.resolveId(id, importer)
</span><span class="token prefix inserted">+</span><span class="token line">   }
</span></span><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line"> }
</span><span class="token prefix unchanged"> </span><span class="token line"> //插件容器是一个用来执行插件的容器
</span><span class="token prefix unchanged"> </span><span class="token line"> const container = {
</span><span class="token prefix unchanged"> </span><span class="token line">   //resolve是一个方法，是一个根据标记符计算路径的方法
</span><span class="token prefix unchanged"> </span><span class="token line">   //vue=&gt;vue在硬盘上对应路径 
</span><span class="token prefix unchanged"> </span><span class="token line">   async resolveId(id, importer) {
</span><span class="token prefix unchanged"> </span><span class="token line">     let ctx = new PluginContext();
</span><span class="token prefix unchanged"> </span><span class="token line">     let resolveId = id;
</span><span class="token prefix unchanged"> </span><span class="token line">     for (const plugin of plugins) {
</span><span class="token prefix unchanged"> </span><span class="token line">       if (!plugin.resolveId) continue;
</span><span class="token prefix unchanged"> </span><span class="token line">       const result = await plugin.resolveId.call(ctx, id, importer);
</span><span class="token prefix unchanged"> </span><span class="token line">       if (result) {
</span><span class="token prefix unchanged"> </span><span class="token line">         resolveId = result.id || result;
</span><span class="token prefix unchanged"> </span><span class="token line">         break;
</span><span class="token prefix unchanged"> </span><span class="token line">       }
</span><span class="token prefix unchanged"> </span><span class="token line">     }
</span><span class="token prefix unchanged"> </span><span class="token line">     return { id: normalizePath(resolveId) }
</span><span class="token prefix unchanged"> </span><span class="token line">   },
</span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">   async load(id) {
</span><span class="token prefix inserted">+</span><span class="token line">     const ctx = new PluginContext()
</span><span class="token prefix inserted">+</span><span class="token line">     for (const plugin of plugins) {
</span><span class="token prefix inserted">+</span><span class="token line">       if (!plugin.load) continue
</span><span class="token prefix inserted">+</span><span class="token line">       const result = await plugin.load.call(ctx, id)
</span><span class="token prefix inserted">+</span><span class="token line">       if (result !== null) {
</span><span class="token prefix inserted">+</span><span class="token line">         return result
</span><span class="token prefix inserted">+</span><span class="token line">       }
</span><span class="token prefix inserted">+</span><span class="token line">     }
</span><span class="token prefix inserted">+</span><span class="token line">     return null
</span><span class="token prefix inserted">+</span><span class="token line">   },
</span><span class="token prefix inserted">+</span><span class="token line">   async transform(code, id) {
</span><span class="token prefix inserted">+</span><span class="token line">     for (const plugin of plugins) {
</span><span class="token prefix inserted">+</span><span class="token line">       if (!plugin.transform) continue
</span><span class="token prefix inserted">+</span><span class="token line">       const ctx = new PluginContext()
</span><span class="token prefix inserted">+</span><span class="token line">       const result = await plugin.transform.call(ctx, code, id)
</span><span class="token prefix inserted">+</span><span class="token line">       if (!result) continue
</span><span class="token prefix inserted">+</span><span class="token line">       code = result.code || result;
</span><span class="token prefix inserted">+</span><span class="token line">     }
</span><span class="token prefix inserted">+</span><span class="token line">     return { code }
</span><span class="token prefix inserted">+</span><span class="token line">   }
</span></span><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line"> }
</span><span class="token prefix unchanged"> </span><span class="token line"> return container;
</span></span>}
exports.createPluginContainer = createPluginContainer;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br></div></div><h3 id="_7-4-utils-js"><a href="#_7-4-utils-js" class="header-anchor">#</a> 7.4 utils.js</h3> <p>lib\utils.js</p> <div class="language-diff line-numbers-mode"><pre class="language-diff"><code>function normalizePath(id) {
<span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line"> return id.replace(/\\/g, '/')
</span></span>}
exports.normalizePath = normalizePath;

<span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">const knownJsSrcRE = /\.js/
</span><span class="token prefix inserted">+</span><span class="token line">const isJSRequest = (url) =&gt; {
</span><span class="token prefix inserted">+</span><span class="token line">  if (knownJsSrcRE.test(url)) {
</span><span class="token prefix inserted">+</span><span class="token line">    return true
</span><span class="token prefix inserted">+</span><span class="token line">  }
</span><span class="token prefix inserted">+</span><span class="token line">  return false
</span><span class="token prefix inserted">+</span><span class="token line">}
</span><span class="token prefix inserted">+</span><span class="token line">exports.isJSRequest = isJSRequest;
</span></span></code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><h3 id="_7-5-transformrequest-js"><a href="#_7-5-transformrequest-js" class="header-anchor">#</a> 7.5 transformRequest.js</h3> <p>lib\server\transformRequest.js</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs-extra'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">transformRequest</span><span class="token punctuation">(</span><span class="token parameter">url<span class="token punctuation">,</span> server</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> pluginContainer <span class="token punctuation">}</span> <span class="token operator">=</span> server
  <span class="token keyword">const</span> <span class="token punctuation">{</span> id <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">await</span> pluginContainer<span class="token punctuation">.</span><span class="token function">resolveId</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> loadResult <span class="token operator">=</span> <span class="token keyword">await</span> pluginContainer<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span>
   <span class="token keyword">let</span> code<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>loadResult<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    code <span class="token operator">=</span> loadResult<span class="token punctuation">.</span>code<span class="token punctuation">;</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    code <span class="token operator">=</span> <span class="token keyword">await</span> fs<span class="token punctuation">.</span><span class="token function">readFile</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> <span class="token string">'utf-8'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">const</span> transformResult <span class="token operator">=</span> <span class="token keyword">await</span> pluginContainer<span class="token punctuation">.</span><span class="token function">transform</span><span class="token punctuation">(</span>code<span class="token punctuation">,</span> id<span class="token punctuation">)</span>
  <span class="token keyword">return</span> transformResult<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> transformRequest<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><h3 id="_7-6-send-js"><a href="#_7-6-send-js" class="header-anchor">#</a> 7.6 send.js</h3> <p>lib\server\send.js</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> alias <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">js</span><span class="token operator">:</span> <span class="token string">'application/javascript'</span><span class="token punctuation">,</span>
  <span class="token literal-property property">css</span><span class="token operator">:</span> <span class="token string">'text/css'</span><span class="token punctuation">,</span>
  <span class="token literal-property property">html</span><span class="token operator">:</span> <span class="token string">'text/html'</span><span class="token punctuation">,</span>
  <span class="token literal-property property">json</span><span class="token operator">:</span> <span class="token string">'application/json'</span>
<span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">send</span><span class="token punctuation">(</span><span class="token parameter">_req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> content<span class="token punctuation">,</span> type</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  res<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">'Content-Type'</span><span class="token punctuation">,</span> alias<span class="token punctuation">[</span>type<span class="token punctuation">]</span> <span class="token operator">||</span> type<span class="token punctuation">)</span>
  res<span class="token punctuation">.</span>statusCode <span class="token operator">=</span> <span class="token number">200</span>
  <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> send<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><h3 id="_7-7-plugins-index-js"><a href="#_7-7-plugins-index-js" class="header-anchor">#</a> 7.7 plugins\index.js</h3> <p>lib\plugins\index.js</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> importAnalysisPlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./importAnalysis'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> preAliasPlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./preAlias'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> resolvePlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./resolve'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">resolvePlugins</span><span class="token punctuation">(</span><span class="token parameter">config</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">[</span>
    <span class="token function">preAliasPlugin</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">resolvePlugin</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">importAnalysisPlugin</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
exports<span class="token punctuation">.</span>resolvePlugins <span class="token operator">=</span> resolvePlugins<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><h3 id="_7-8-importanalysis-js"><a href="#_7-8-importanalysis-js" class="header-anchor">#</a> 7.8 importAnalysis.js</h3> <p>lib\plugins\importAnalysis.js</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token punctuation">{</span> init<span class="token punctuation">,</span> parse <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'es-module-lexer'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> MagicString <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'magic-string'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">function</span> <span class="token function">importAnalysisPlugin</span><span class="token punctuation">(</span><span class="token parameter">config</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> root <span class="token punctuation">}</span> <span class="token operator">=</span> config
  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'vite:import-analysis'</span><span class="token punctuation">,</span>
    <span class="token keyword">async</span> <span class="token function">transform</span><span class="token punctuation">(</span><span class="token parameter">source<span class="token punctuation">,</span> importer</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">await</span> init
      <span class="token keyword">let</span> imports <span class="token operator">=</span> <span class="token function">parse</span><span class="token punctuation">(</span>source<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>imports<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> source
      <span class="token punctuation">}</span>
      <span class="token keyword">let</span> ms <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MagicString</span><span class="token punctuation">(</span>source<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> <span class="token function-variable function">normalizeUrl</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">url</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> resolved <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> importer<span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>resolved<span class="token punctuation">.</span>id<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span>root <span class="token operator">+</span> <span class="token string">'/'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          url <span class="token operator">=</span> resolved<span class="token punctuation">.</span>id<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span>root<span class="token punctuation">.</span>length<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> url<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> index <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> index <span class="token operator">&lt;</span> imports<span class="token punctuation">.</span>length<span class="token punctuation">;</span> index<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token literal-property property">s</span><span class="token operator">:</span> start<span class="token punctuation">,</span> <span class="token literal-property property">e</span><span class="token operator">:</span> end<span class="token punctuation">,</span> <span class="token literal-property property">n</span><span class="token operator">:</span> specifier <span class="token punctuation">}</span> <span class="token operator">=</span> imports<span class="token punctuation">[</span>index<span class="token punctuation">]</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>specifier<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">const</span> normalizedUrl <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">normalizeUrl</span><span class="token punctuation">(</span>specifier<span class="token punctuation">)</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>normalizedUrl <span class="token operator">!==</span> specifier<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            ms<span class="token punctuation">.</span><span class="token function">overwrite</span><span class="token punctuation">(</span>start<span class="token punctuation">,</span> end<span class="token punctuation">,</span> normalizedUrl<span class="token punctuation">)</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">return</span> ms<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> importAnalysisPlugin<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br></div></div><h3 id="_7-9-prealias-js"><a href="#_7-9-prealias-js" class="header-anchor">#</a> 7.9 preAlias.js</h3> <p>lib\plugins\preAlias.js</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs-extra'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">function</span> <span class="token function">preAliasPlugin</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> server
  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'vite:pre-alias'</span><span class="token punctuation">,</span>
    <span class="token function">configureServer</span><span class="token punctuation">(</span><span class="token parameter">_server</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      server <span class="token operator">=</span> _server
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function">resolveId</span><span class="token punctuation">(</span><span class="token parameter">id</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> metadata <span class="token operator">=</span> server<span class="token punctuation">.</span>_optimizeDepsMetadata<span class="token punctuation">;</span>
      <span class="token keyword">const</span> isOptimized <span class="token operator">=</span> metadata<span class="token punctuation">.</span>optimized<span class="token punctuation">[</span>id<span class="token punctuation">]</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>isOptimized<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token punctuation">{</span>
          <span class="token literal-property property">id</span><span class="token operator">:</span> isOptimized<span class="token punctuation">.</span>file
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> preAliasPlugin<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><h3 id="_7-10-lib-config-js"><a href="#_7-10-lib-config-js" class="header-anchor">#</a> 7.10 lib\config.js</h3> <p>lib\config.js</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> normalizePath <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./utils'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> resolvePlugins <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./plugins'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">resolveConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">//当前的根目录 window \\  linux /</span>
  <span class="token keyword">const</span> root <span class="token operator">=</span> <span class="token function">normalizePath</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span><span class="token function">cwd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> cacheDir <span class="token operator">=</span> <span class="token function">normalizePath</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">node_modules/.vite7</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token keyword">let</span> config <span class="token operator">=</span> <span class="token punctuation">{</span>
    root<span class="token punctuation">,</span>
    cacheDir
  <span class="token punctuation">}</span>
  <span class="token keyword">const</span> plugins <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">resolvePlugins</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">;</span>
  config<span class="token punctuation">.</span>plugins <span class="token operator">=</span> plugins<span class="token punctuation">;</span>
  <span class="token keyword">return</span> config<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> resolveConfig<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><h2 id="_8-支持vue插件"><a href="#_8-支持vue插件" class="header-anchor">#</a> 8.支持vue插件</h2> <h3 id="_8-1-esbuilddepplugin-js"><a href="#_8-1-esbuilddepplugin-js" class="header-anchor">#</a> 8.1 esbuildDepPlugin.js</h3> <p>lib\optimizer\esbuildDepPlugin.js</p> <div class="language-diff line-numbers-mode"><pre class="language-diff"><code>const path = require('path');
const fs = require('fs-extra');
const htmlTypesRE = /\.html$/;
const scriptModuleRE = /&lt;script src\=&quot;(.+?)&quot; type\=&quot;module&quot;&gt;&lt;\/script&gt;/;
const { createPluginContainer } = require('../server/pluginContainer');
const resolvePlugin = require('../plugins/resolve');
const jsRE = /\.js$/;
async function esBuildScanPlugin(config, deps) {
<span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line"> //在此处其实调用的vite插件系统
</span><span class="token prefix unchanged"> </span><span class="token line"> config.plugins = [resolvePlugin(config)];
</span><span class="token prefix unchanged"> </span><span class="token line"> const container = await createPluginContainer(config);
</span><span class="token prefix unchanged"> </span><span class="token line"> const resolve = async (id, importer) =&gt; {
</span><span class="token prefix unchanged"> </span><span class="token line">   return await container.resolveId(id, importer);
</span><span class="token prefix unchanged"> </span><span class="token line"> }
</span><span class="token prefix unchanged"> </span><span class="token line"> return {
</span><span class="token prefix unchanged"> </span><span class="token line">   name: 'vite:dep-scan',
</span><span class="token prefix unchanged"> </span><span class="token line">   setup(build) {
</span><span class="token prefix unchanged"> </span><span class="token line">     //X [ERROR] No loader is configured for &quot;.vue&quot; files: src/App.vue
</span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">     build.onResolve(
</span><span class="token prefix inserted">+</span><span class="token line">       {
</span><span class="token prefix inserted">+</span><span class="token line">         filter: /\.vue$/
</span><span class="token prefix inserted">+</span><span class="token line">       },
</span><span class="token prefix inserted">+</span><span class="token line">       async ({ path: id, importer }) =&gt; {
</span><span class="token prefix inserted">+</span><span class="token line">         const resolved = await resolve(id, importer)
</span><span class="token prefix inserted">+</span><span class="token line">         if (resolved) {
</span><span class="token prefix inserted">+</span><span class="token line">           return {
</span><span class="token prefix inserted">+</span><span class="token line">             path: resolved.id,
</span><span class="token prefix inserted">+</span><span class="token line">             external: true
</span><span class="token prefix inserted">+</span><span class="token line">           }
</span><span class="token prefix inserted">+</span><span class="token line">         }
</span><span class="token prefix inserted">+</span><span class="token line">       }
</span><span class="token prefix inserted">+</span><span class="token line">     )
</span></span><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">     //用来处理路径的
</span><span class="token prefix unchanged"> </span><span class="token line">     build.onResolve({ filter: htmlTypesRE }, async ({ path, importer }) =&gt; {
</span><span class="token prefix unchanged"> </span><span class="token line">       //path=C:\aproject\vite5\doc\index.html importer 空
</span><span class="token prefix unchanged"> </span><span class="token line">       const resolved = await resolve(path, importer);
</span><span class="token prefix unchanged"> </span><span class="token line">       if (resolved) {
</span><span class="token prefix unchanged"> </span><span class="token line">         return {
</span><span class="token prefix unchanged"> </span><span class="token line">           path: resolved.id || resolved,
</span><span class="token prefix unchanged"> </span><span class="token line">           namespace: 'html' //为了更细化区分不同的文件类型，我可以给文件添加一个命名空间
</span><span class="token prefix unchanged"> </span><span class="token line">         }
</span><span class="token prefix unchanged"> </span><span class="token line">       }
</span><span class="token prefix unchanged"> </span><span class="token line">     });
</span><span class="token prefix unchanged"> </span><span class="token line">     //对于其它所有的类型文件我们也进行处理
</span><span class="token prefix unchanged"> </span><span class="token line">     build.onResolve({ filter: /.*/ }, async ({ path, importer }) =&gt; {
</span><span class="token prefix unchanged"> </span><span class="token line">       const resolved = await resolve(path, importer);
</span><span class="token prefix unchanged"> </span><span class="token line">       //返回值可能是 {id:xx} 或 xx
</span><span class="token prefix unchanged"> </span><span class="token line">       //C:\aproject\vite5\doc\main.js
</span><span class="token prefix unchanged"> </span><span class="token line">       if (resolved) {
</span><span class="token prefix unchanged"> </span><span class="token line">         const id = resolved.id || resolved;
</span><span class="token prefix unchanged"> </span><span class="token line">         const included = id.includes('node_modules');
</span><span class="token prefix unchanged"> </span><span class="token line">         if (included) {
</span><span class="token prefix unchanged"> </span><span class="token line">           //deps.vue = &quot;C:/aproject/viteproject/node_modules/vue/dist/vue.runtime.esm-bundler.js&quot;
</span><span class="token prefix unchanged"> </span><span class="token line">           deps[path] = id;
</span><span class="token prefix unchanged"> </span><span class="token line">           return {
</span><span class="token prefix unchanged"> </span><span class="token line">             path,
</span><span class="token prefix unchanged"> </span><span class="token line">             external: true //external设置为true的话说明这是一个外部模块，不会进行后续的打包分析，直接返回了
</span><span class="token prefix unchanged"> </span><span class="token line">           }
</span><span class="token prefix unchanged"> </span><span class="token line">         }
</span><span class="token prefix unchanged"> </span><span class="token line">         return { path: id }
</span><span class="token prefix unchanged"> </span><span class="token line">       }
</span><span class="token prefix unchanged"> </span><span class="token line">       return { path }
</span><span class="token prefix unchanged"> </span><span class="token line">     });
</span><span class="token prefix unchanged"> </span><span class="token line">     //用来处理读取内容 自定义读取器
</span><span class="token prefix unchanged"> </span><span class="token line">     build.onLoad({ filter: htmlTypesRE, namespace: 'html' }, async ({ path }) =&gt; {
</span><span class="token prefix unchanged"> </span><span class="token line">       let html = fs.readFileSync(path, 'utf8');
</span><span class="token prefix unchanged"> </span><span class="token line">       let [, scriptSrc] = html.match(scriptModuleRE);
</span><span class="token prefix unchanged"> </span><span class="token line">       let js = `import ${JSON.stringify(scriptSrc)}`;//import &quot;/main.js&quot;
</span><span class="token prefix unchanged"> </span><span class="token line">       return {
</span><span class="token prefix unchanged"> </span><span class="token line">         loader: 'js',
</span><span class="token prefix unchanged"> </span><span class="token line">         contents: js
</span><span class="token prefix unchanged"> </span><span class="token line">       }
</span><span class="token prefix unchanged"> </span><span class="token line">     })
</span><span class="token prefix unchanged"> </span><span class="token line">     build.onLoad({ filter: jsRE }, async ({ path: id }) =&gt; {
</span><span class="token prefix unchanged"> </span><span class="token line">       let ext = path.extname(id).slice(1);// .js  js
</span><span class="token prefix unchanged"> </span><span class="token line">       const contents = fs.readFileSync(id, 'utf8');
</span><span class="token prefix unchanged"> </span><span class="token line">       return {
</span><span class="token prefix unchanged"> </span><span class="token line">         loader: ext,
</span><span class="token prefix unchanged"> </span><span class="token line">         contents
</span><span class="token prefix unchanged"> </span><span class="token line">       }
</span><span class="token prefix unchanged"> </span><span class="token line">     })
</span><span class="token prefix unchanged"> </span><span class="token line">   }
</span><span class="token prefix unchanged"> </span><span class="token line"> }
</span></span>}
module.exports = esBuildScanPlugin;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br></div></div><h3 id="_8-2-lib-plugins-index-js"><a href="#_8-2-lib-plugins-index-js" class="header-anchor">#</a> 8.2 lib\plugins\index.js</h3> <p>lib\plugins\index.js</p> <div class="language-diff line-numbers-mode"><pre class="language-diff"><code>const importAnalysisPlugin = require('./importAnalysis');
const preAliasPlugin = require('./preAlias');
const resolvePlugin = require('./resolve');
<span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">async function resolvePlugins(config, userPlugins) {
</span></span><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line"> return [
</span><span class="token prefix unchanged"> </span><span class="token line">   preAliasPlugin(config),
</span><span class="token prefix unchanged"> </span><span class="token line">   resolvePlugin(config),
</span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">   ...userPlugins,
</span></span><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">   importAnalysisPlugin(config)
</span><span class="token prefix unchanged"> </span><span class="token line"> ]
</span></span>}
exports.resolvePlugins = resolvePlugins;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><h3 id="_8-3-lib-utils-js"><a href="#_8-3-lib-utils-js" class="header-anchor">#</a> 8.3 lib\utils.js</h3> <p>lib\utils.js</p> <div class="language-diff line-numbers-mode"><pre class="language-diff"><code>function normalizePath(id) {
<span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line"> return id.replace(/\\/g, '/')
</span></span>}
exports.normalizePath = normalizePath;
<span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">const knownJsSrcRE = /\.(js|vue)/
</span></span>const isJSRequest = (url) =&gt; {
<span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line"> if (knownJsSrcRE.test(url)) {
</span><span class="token prefix unchanged"> </span><span class="token line">   return true
</span><span class="token prefix unchanged"> </span><span class="token line"> }
</span><span class="token prefix unchanged"> </span><span class="token line"> return false
</span></span>}
exports.isJSRequest = isJSRequest;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><h3 id="_8-4-config-js"><a href="#_8-4-config-js" class="header-anchor">#</a> 8.4 config.js</h3> <p>lib\config.js</p> <div class="language-diff line-numbers-mode"><pre class="language-diff"><code>const path = require('path');
const { normalizePath } = require('./utils');
const { resolvePlugins } = require('./plugins');
<span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">const fs = require('fs-extra');
</span></span>async function resolveConfig() {
<span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line"> //当前的根目录 window \\  linux /
</span><span class="token prefix unchanged"> </span><span class="token line"> const root = normalizePath(process.cwd());
</span><span class="token prefix unchanged"> </span><span class="token line"> const cacheDir = normalizePath(path.resolve(`node_modules/.vite7`))
</span><span class="token prefix unchanged"> </span><span class="token line"> let config = {
</span><span class="token prefix unchanged"> </span><span class="token line">   root,
</span><span class="token prefix unchanged"> </span><span class="token line">   cacheDir
</span><span class="token prefix unchanged"> </span><span class="token line"> }
</span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line"> const jsconfigFile = path.resolve(root, 'vite.config.js')
</span><span class="token prefix inserted">+</span><span class="token line"> const exists = await fs.pathExists(jsconfigFile)
</span><span class="token prefix inserted">+</span><span class="token line"> if (exists) {
</span><span class="token prefix inserted">+</span><span class="token line">   const userConfig = require(jsconfigFile);
</span><span class="token prefix inserted">+</span><span class="token line">   config = { ...config, ...userConfig };
</span><span class="token prefix inserted">+</span><span class="token line"> }
</span><span class="token prefix inserted">+</span><span class="token line"> const userPlugins = config.plugins || [];
</span><span class="token prefix inserted">+</span><span class="token line"> const plugins = await resolvePlugins(config, userPlugins);
</span></span><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line"> config.plugins = plugins;
</span><span class="token prefix unchanged"> </span><span class="token line"> return config;
</span></span>}
module.exports = resolveConfig;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><h3 id="_8-5-index-html"><a href="#_8-5-index-html" class="header-anchor">#</a> 8.5 index.html</h3> <p>index.html</p> <div class="language-html line-numbers-mode"><pre class="language-html"><code><span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">html</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>en<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>UTF-8<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">http-equiv</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>X-UA-Compatible<span class="token punctuation">&quot;</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>IE=edge<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>viewport<span class="token punctuation">&quot;</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>width=device-width, initial-scale=1.0<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">&gt;</span></span>Document<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>app<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>/src/main.js<span class="token punctuation">&quot;</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>module<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><h3 id="_8-6-src-main-js"><a href="#_8-6-src-main-js" class="header-anchor">#</a> 8.6 src\main.js</h3> <p>src\main.js</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> createApp <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'vue'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> App <span class="token keyword">from</span> <span class="token string">'/src/App.vue'</span><span class="token punctuation">;</span>
<span class="token function">createApp</span><span class="token punctuation">(</span>App<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">mount</span><span class="token punctuation">(</span><span class="token string">&quot;#app&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h3 id="_8-7-src-app-vue"><a href="#_8-7-src-app-vue" class="header-anchor">#</a> 8.7 src\App.vue</h3> <p>src\App.vue</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token operator">&lt;</span>template<span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span>h1<span class="token operator">&gt;</span>App<span class="token operator">&lt;</span><span class="token operator">/</span>h1<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>template<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>script<span class="token operator">&gt;</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'App'</span>
<span class="token punctuation">}</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h3 id="_8-8-vue-js"><a href="#_8-8-vue-js" class="header-anchor">#</a> 8.8 vue.js</h3> <p>plugins\vue.js</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token punctuation">{</span> parse<span class="token punctuation">,</span> compileScript<span class="token punctuation">,</span> rewriteDefault<span class="token punctuation">,</span> compileTemplate <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'vue/compiler-sfc'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> descriptorCache <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">function</span> <span class="token function">vue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'vue'</span><span class="token punctuation">,</span>
    <span class="token keyword">async</span> <span class="token function">transform</span><span class="token punctuation">(</span><span class="token parameter">code<span class="token punctuation">,</span> id</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> <span class="token punctuation">{</span> filename <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">parseVueRequest</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>filename<span class="token punctuation">.</span><span class="token function">endsWith</span><span class="token punctuation">(</span><span class="token string">'.vue'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> result <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">transformMain</span><span class="token punctuation">(</span>code<span class="token punctuation">,</span> filename<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> result<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">getDescriptor</span><span class="token punctuation">(</span><span class="token parameter">filename</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> descriptor <span class="token operator">=</span> descriptorCache<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>filename<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>descriptor<span class="token punctuation">)</span> <span class="token keyword">return</span> descriptor<span class="token punctuation">;</span>
  <span class="token keyword">const</span> content <span class="token operator">=</span> <span class="token keyword">await</span> fs<span class="token punctuation">.</span>promises<span class="token punctuation">.</span><span class="token function">readFile</span><span class="token punctuation">(</span>filename<span class="token punctuation">,</span> <span class="token string">'utf8'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token function">parse</span><span class="token punctuation">(</span>content<span class="token punctuation">,</span> <span class="token punctuation">{</span> filename <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  descriptor <span class="token operator">=</span> result<span class="token punctuation">.</span>descriptor<span class="token punctuation">;</span>
  descriptorCache<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>filename<span class="token punctuation">,</span> descriptor<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> descriptor<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">transformMain</span><span class="token punctuation">(</span><span class="token parameter">source<span class="token punctuation">,</span> filename</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> descriptor <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">getDescriptor</span><span class="token punctuation">(</span>filename<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> scriptCode <span class="token operator">=</span> <span class="token function">genScriptCode</span><span class="token punctuation">(</span>descriptor<span class="token punctuation">,</span> filename<span class="token punctuation">)</span>
  <span class="token keyword">const</span> templateCode <span class="token operator">=</span> <span class="token function">genTemplateCode</span><span class="token punctuation">(</span>descriptor<span class="token punctuation">,</span> filename<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> resolvedCode <span class="token operator">=</span> <span class="token punctuation">[</span>
    templateCode<span class="token punctuation">,</span>
    scriptCode<span class="token punctuation">,</span>
    <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">_sfc_main['render'] = render</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
    <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">export default _sfc_main</span><span class="token template-punctuation string">`</span></span>
  <span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">'\n'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span> <span class="token literal-property property">code</span><span class="token operator">:</span> resolvedCode <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">genScriptCode</span><span class="token punctuation">(</span><span class="token parameter">descriptor<span class="token punctuation">,</span> id</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> scriptCode <span class="token operator">=</span> <span class="token string">''</span>
  <span class="token keyword">let</span> script <span class="token operator">=</span> <span class="token function">compileScript</span><span class="token punctuation">(</span>descriptor<span class="token punctuation">,</span> <span class="token punctuation">{</span> id <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>script<span class="token punctuation">.</span>lang<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    scriptCode <span class="token operator">=</span> <span class="token function">rewriteDefault</span><span class="token punctuation">(</span>
      script<span class="token punctuation">.</span>content<span class="token punctuation">,</span>
      <span class="token string">'_sfc_main'</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> scriptCode<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">genTemplateCode</span><span class="token punctuation">(</span><span class="token parameter">descriptor<span class="token punctuation">,</span> id</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> content <span class="token operator">=</span> descriptor<span class="token punctuation">.</span>template<span class="token punctuation">.</span>content<span class="token punctuation">;</span>
  <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token function">compileTemplate</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">source</span><span class="token operator">:</span> content<span class="token punctuation">,</span> id <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> result<span class="token punctuation">.</span>code<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">parseVueRequest</span><span class="token punctuation">(</span><span class="token parameter">id</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>filename<span class="token punctuation">,</span> querystring <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">]</span> <span class="token operator">=</span> id<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">'?'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> query <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">URLSearchParams</span><span class="token punctuation">(</span>querystring<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    filename<span class="token punctuation">,</span> query
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> vue<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br></div></div><h2 id="_9-支持style"><a href="#_9-支持style" class="header-anchor">#</a> 9.支持style</h2> <h3 id="_9-1-config-js"><a href="#_9-1-config-js" class="header-anchor">#</a> 9.1 config.js</h3> <p>lib\config.js</p> <div class="language-diff line-numbers-mode"><pre class="language-diff"><code>const path = require('path');
const { normalizePath } = require('./utils');
const { resolvePlugins } = require('./plugins');
const fs = require('fs-extra');
async function resolveConfig() {
<span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line"> //当前的根目录 window \\  linux /
</span><span class="token prefix unchanged"> </span><span class="token line"> const root = normalizePath(process.cwd());
</span><span class="token prefix unchanged"> </span><span class="token line"> const cacheDir = normalizePath(path.resolve(`node_modules/.vite7`))
</span><span class="token prefix unchanged"> </span><span class="token line"> let config = {
</span><span class="token prefix unchanged"> </span><span class="token line">   root,
</span><span class="token prefix unchanged"> </span><span class="token line">   cacheDir
</span><span class="token prefix unchanged"> </span><span class="token line"> }
</span><span class="token prefix unchanged"> </span><span class="token line"> const jsconfigFile = path.resolve(root, 'vite.config.js')
</span><span class="token prefix unchanged"> </span><span class="token line"> const exists = await fs.pathExists(jsconfigFile)
</span><span class="token prefix unchanged"> </span><span class="token line"> if (exists) {
</span><span class="token prefix unchanged"> </span><span class="token line">   const userConfig = require(jsconfigFile);
</span><span class="token prefix unchanged"> </span><span class="token line">   config = { ...config, ...userConfig };
</span><span class="token prefix unchanged"> </span><span class="token line"> }
</span><span class="token prefix unchanged"> </span><span class="token line"> const userPlugins = config.plugins || [];
</span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line"> for (const plugin of userPlugins) {
</span><span class="token prefix inserted">+</span><span class="token line">   if (plugin.config) {
</span><span class="token prefix inserted">+</span><span class="token line">     const res = await plugin.config(config)
</span><span class="token prefix inserted">+</span><span class="token line">     if (res) {
</span><span class="token prefix inserted">+</span><span class="token line">       config = { ...config, ...res }
</span><span class="token prefix inserted">+</span><span class="token line">     }
</span><span class="token prefix inserted">+</span><span class="token line">   }
</span><span class="token prefix inserted">+</span><span class="token line"> }
</span></span><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line"> const plugins = await resolvePlugins(config, userPlugins);
</span><span class="token prefix unchanged"> </span><span class="token line"> config.plugins = plugins;
</span><span class="token prefix unchanged"> </span><span class="token line"> return config;
</span></span>}
module.exports = resolveConfig;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br></div></div><h3 id="_9-2-src-app-vue"><a href="#_9-2-src-app-vue" class="header-anchor">#</a> 9.2 src\App.vue</h3> <p>src\App.vue</p> <div class="language-diff line-numbers-mode"><pre class="language-diff"><code><span class="token deleted-arrow deleted"><span class="token prefix deleted">&lt;</span><span class="token line">template&gt;
</span></span><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line"> &lt;h1&gt;App&lt;/h1&gt;
</span></span><span class="token deleted-arrow deleted"><span class="token prefix deleted">&lt;</span><span class="token line">/template&gt;
</span><span class="token prefix deleted">&lt;</span><span class="token line">script&gt;
</span></span>export default {
<span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line"> name: 'App'
</span></span>}
<span class="token deleted-arrow deleted"><span class="token prefix deleted">&lt;</span><span class="token line">/script&gt;
</span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">&lt;style&gt;
</span><span class="token prefix inserted">+</span><span class="token line">h1 {
</span><span class="token prefix inserted">+</span><span class="token line">  color: red;
</span><span class="token prefix inserted">+</span><span class="token line">}
</span><span class="token prefix inserted">+</span><span class="token line">&lt;/style&gt;
</span></span></code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><h3 id="_9-3-vue-js"><a href="#_9-3-vue-js" class="header-anchor">#</a> 9.3 vue.js</h3> <p>plugins\vue.js</p> <div class="language-diff line-numbers-mode"><pre class="language-diff"><code><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">const { parse, compileScript, rewriteDefault, compileTemplate, compileStyleAsync } = require('vue/compiler-sfc');
</span></span>const fs = require('fs');
const path = require('path');
<span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">const hash = require('hash-sum');
</span><span class="token prefix inserted">+</span><span class="token line">const descriptorCache = new Map();
</span></span>function vue() {
<span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line"> let root;
</span><span class="token prefix unchanged"> </span><span class="token line"> return {
</span><span class="token prefix unchanged"> </span><span class="token line">   name: 'vue',
</span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">   config(config) {
</span><span class="token prefix inserted">+</span><span class="token line">     root = config.root;
</span><span class="token prefix inserted">+</span><span class="token line">     console.log(root, 'root');
</span><span class="token prefix inserted">+</span><span class="token line">   },
</span><span class="token prefix inserted">+</span><span class="token line">   async load(id) {
</span><span class="token prefix inserted">+</span><span class="token line">     const { filename, query } = parseVueRequest(id);
</span><span class="token prefix inserted">+</span><span class="token line">     if (query.has('vue')) {
</span><span class="token prefix inserted">+</span><span class="token line">       const descriptor = await getDescriptor(filename, root);
</span><span class="token prefix inserted">+</span><span class="token line">       if (query.get('type') === 'style') {
</span><span class="token prefix inserted">+</span><span class="token line">         let block = descriptor.styles[Number(query.get('index'))];
</span><span class="token prefix inserted">+</span><span class="token line">         if (block) {
</span><span class="token prefix inserted">+</span><span class="token line">           return { code: block.content };
</span><span class="token prefix inserted">+</span><span class="token line">         }
</span><span class="token prefix inserted">+</span><span class="token line">       }
</span><span class="token prefix inserted">+</span><span class="token line">     }
</span><span class="token prefix inserted">+</span><span class="token line">   },
</span></span><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">   async transform(code, id) {
</span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">     const { filename, query } = parseVueRequest(id);
</span><span class="token prefix inserted">+</span><span class="token line">     if (filename.endsWith('.vue')) {
</span><span class="token prefix inserted">+</span><span class="token line">       if (query.get('type') === 'style') {
</span><span class="token prefix inserted">+</span><span class="token line">         const descriptor = await getDescriptor(filename, root);
</span><span class="token prefix inserted">+</span><span class="token line">         let result = await transformStyle(code, descriptor, query.get('index'));
</span><span class="token prefix inserted">+</span><span class="token line">         return result;
</span><span class="token prefix inserted">+</span><span class="token line">       } else {
</span><span class="token prefix inserted">+</span><span class="token line">         let result = await transformMain(code, filename);
</span><span class="token prefix inserted">+</span><span class="token line">         return result;
</span><span class="token prefix inserted">+</span><span class="token line">       }
</span><span class="token prefix inserted">+</span><span class="token line">     }
</span></span><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">     return null;
</span><span class="token prefix unchanged"> </span><span class="token line">   }
</span><span class="token prefix unchanged"> </span><span class="token line"> }
</span></span>}
<span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">async function transformStyle(code, descriptor, index) {
</span><span class="token prefix inserted">+</span><span class="token line">  const block = descriptor.styles[index];
</span><span class="token prefix inserted">+</span><span class="token line">  //如果是CSS，其实翻译之后和翻译之前内容是一样的
</span><span class="token prefix inserted">+</span><span class="token line">  const result = await compileStyleAsync({
</span><span class="token prefix inserted">+</span><span class="token line">    filename: descriptor.filename,
</span><span class="token prefix inserted">+</span><span class="token line">    source: code,
</span><span class="token prefix inserted">+</span><span class="token line">    id: `data-v-${descriptor.id}`,//必须传递，不然报错
</span><span class="token prefix inserted">+</span><span class="token line">    scoped: block.scoped
</span><span class="token prefix inserted">+</span><span class="token line">  });
</span><span class="token prefix inserted">+</span><span class="token line">  let styleCode = result.code;
</span><span class="token prefix inserted">+</span><span class="token line">  const injectCode =
</span><span class="token prefix inserted">+</span><span class="token line">    `\nvar  style = document.createElement('style');` +
</span><span class="token prefix inserted">+</span><span class="token line">    `\nstyle.innerHTML = ${JSON.stringify(styleCode)};` +
</span><span class="token prefix inserted">+</span><span class="token line">    `\ndocument.head.appendChild(style);`
</span><span class="token prefix inserted">+</span><span class="token line">  return {
</span><span class="token prefix inserted">+</span><span class="token line">    code: injectCode
</span><span class="token prefix inserted">+</span><span class="token line">  };
</span><span class="token prefix inserted">+</span><span class="token line">}
</span><span class="token prefix inserted">+</span><span class="token line">async function getDescriptor(filename, root) {
</span><span class="token prefix inserted">+</span><span class="token line">  let descriptor = descriptorCache.get(filename);
</span><span class="token prefix inserted">+</span><span class="token line">  if (descriptor) return descriptor;
</span><span class="token prefix inserted">+</span><span class="token line">  const content = await fs.promises.readFile(filename, 'utf8');
</span><span class="token prefix inserted">+</span><span class="token line">  const result = parse(content, { filename });
</span><span class="token prefix inserted">+</span><span class="token line">  descriptor = result.descriptor;
</span><span class="token prefix inserted">+</span><span class="token line">  descriptor.id = hash(path.relative(root, filename));
</span><span class="token prefix inserted">+</span><span class="token line">  descriptorCache.set(filename, descriptor);
</span><span class="token prefix inserted">+</span><span class="token line">  return descriptor;
</span><span class="token prefix inserted">+</span><span class="token line">}
</span></span>async function transformMain(source, filename) {
<span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line"> const descriptor = await getDescriptor(filename, root);
</span><span class="token prefix unchanged"> </span><span class="token line"> const scriptCode = genScriptCode(descriptor, filename)
</span><span class="token prefix unchanged"> </span><span class="token line"> const templateCode = genTemplateCode(descriptor, filename);
</span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line"> const stylesCode = genStyleCode(descriptor, filename);
</span></span><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line"> let resolvedCode = [
</span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">   stylesCode,
</span></span><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">   templateCode,
</span><span class="token prefix unchanged"> </span><span class="token line">   scriptCode,
</span><span class="token prefix unchanged"> </span><span class="token line">   `_sfc_main['render'] = render`,
</span><span class="token prefix unchanged"> </span><span class="token line">   `export default _sfc_main`
</span><span class="token prefix unchanged"> </span><span class="token line"> ].join('\n');
</span><span class="token prefix unchanged"> </span><span class="token line"> return { code: resolvedCode }
</span></span>}
<span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">function genStyleCode(descriptor, filename) {
</span><span class="token prefix inserted">+</span><span class="token line">  let styleCode = '';
</span><span class="token prefix inserted">+</span><span class="token line">  if (descriptor.styles.length) {
</span><span class="token prefix inserted">+</span><span class="token line">    descriptor.styles.forEach((style, index) =&gt; {
</span><span class="token prefix inserted">+</span><span class="token line">      const query = `?vue&amp;type=style&amp;index=${index}&amp;lang=css`;
</span><span class="token prefix inserted">+</span><span class="token line">      const styleRequest = (filename + query).replace(/\\/g, '/');
</span><span class="token prefix inserted">+</span><span class="token line">      styleCode += `\nimport ${JSON.stringify(styleRequest)}`;
</span><span class="token prefix inserted">+</span><span class="token line">    });
</span><span class="token prefix inserted">+</span><span class="token line">    return styleCode;
</span><span class="token prefix inserted">+</span><span class="token line">  }
</span><span class="token prefix inserted">+</span><span class="token line">}
</span></span>function genScriptCode(descriptor, id) {
<span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line"> let scriptCode = ''
</span><span class="token prefix unchanged"> </span><span class="token line"> let script = compileScript(descriptor, { id });
</span><span class="token prefix unchanged"> </span><span class="token line"> if (!script.lang) {
</span><span class="token prefix unchanged"> </span><span class="token line">   scriptCode = rewriteDefault(
</span><span class="token prefix unchanged"> </span><span class="token line">     script.content,
</span><span class="token prefix unchanged"> </span><span class="token line">     '_sfc_main',
</span><span class="token prefix unchanged"> </span><span class="token line">   )
</span><span class="token prefix unchanged"> </span><span class="token line"> }
</span><span class="token prefix unchanged"> </span><span class="token line"> return scriptCode;
</span></span>}
function genTemplateCode(descriptor, id) {
<span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line"> let content = descriptor.template.content;
</span><span class="token prefix unchanged"> </span><span class="token line"> const result = compileTemplate({ source: content, id });
</span><span class="token prefix unchanged"> </span><span class="token line"> return result.code;
</span></span>}
<span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">function parseVueRequest(id) {
</span><span class="token prefix inserted">+</span><span class="token line">  const [filename, querystring = ''] = id.split('?');
</span><span class="token prefix inserted">+</span><span class="token line">  let query = new URLSearchParams(querystring);
</span><span class="token prefix inserted">+</span><span class="token line">  return {
</span><span class="token prefix inserted">+</span><span class="token line">    filename, query
</span><span class="token prefix inserted">+</span><span class="token line">  };
</span><span class="token prefix inserted">+</span><span class="token line">}
</span></span>module.exports = vue;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br></div></div><h2 id="_10-支持环境变量"><a href="#_10-支持环境变量" class="header-anchor">#</a> 10.支持环境变量</h2> <h3 id="_10-1-plugins-index-js"><a href="#_10-1-plugins-index-js" class="header-anchor">#</a> 10.1 plugins\index.js</h3> <p>lib\plugins\index.js</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> importAnalysisPlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./importAnalysis'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> preAliasPlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./preAlias'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> resolvePlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./resolve'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> definePlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./define'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">resolvePlugins</span><span class="token punctuation">(</span><span class="token parameter">config<span class="token punctuation">,</span> userPlugins</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">[</span>
    <span class="token function">preAliasPlugin</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">resolvePlugin</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token operator">...</span>userPlugins<span class="token punctuation">,</span>
    <span class="token function">definePlugin</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">importAnalysisPlugin</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
exports<span class="token punctuation">.</span>resolvePlugins <span class="token operator">=</span> resolvePlugins<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><h3 id="_10-2-define-js"><a href="#_10-2-define-js" class="header-anchor">#</a> 10.2 define.js</h3> <p>lib\plugins\define.js</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> MagicString <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'magic-string'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">function</span> <span class="token function">definePlugin</span><span class="token punctuation">(</span><span class="token parameter">config</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'vite:define'</span><span class="token punctuation">,</span>
    <span class="token function">transform</span><span class="token punctuation">(</span><span class="token parameter">code</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> replacements <span class="token operator">=</span> config<span class="token punctuation">.</span>define <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> replacementsKeys <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>replacements<span class="token punctuation">)</span>
      <span class="token keyword">const</span> pattern <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RegExp</span><span class="token punctuation">(</span><span class="token string">'('</span> <span class="token operator">+</span> replacementsKeys<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">str</span> <span class="token operator">=&gt;</span> str<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">'|'</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">')'</span><span class="token punctuation">,</span> <span class="token string">'g'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> s <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MagicString</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span>
      <span class="token keyword">let</span> hasReplaced <span class="token operator">=</span> <span class="token boolean">false</span>
      <span class="token keyword">let</span> match
      <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>match <span class="token operator">=</span> pattern<span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        hasReplaced <span class="token operator">=</span> <span class="token boolean">true</span>
        <span class="token keyword">const</span> start <span class="token operator">=</span> match<span class="token punctuation">.</span>index
        <span class="token keyword">const</span> end <span class="token operator">=</span> start <span class="token operator">+</span> match<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>length
        <span class="token keyword">const</span> replacement <span class="token operator">=</span> <span class="token string">''</span> <span class="token operator">+</span> replacements<span class="token punctuation">[</span>match<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">]</span>
        s<span class="token punctuation">.</span><span class="token function">overwrite</span><span class="token punctuation">(</span>start<span class="token punctuation">,</span> end<span class="token punctuation">,</span> replacement<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>hasReplaced<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">return</span> <span class="token punctuation">{</span> <span class="token literal-property property">code</span><span class="token operator">:</span> s<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> definePlugin<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div><h3 id="_10-3-plugins-vue-js"><a href="#_10-3-plugins-vue-js" class="header-anchor">#</a> 10.3 plugins\vue.js</h3> <p>plugins\vue.js</p> <div class="language-diff line-numbers-mode"><pre class="language-diff"><code>const { parse, compileScript, rewriteDefault, compileTemplate, compileStyleAsync } = require('vue/compiler-sfc');
const fs = require('fs');
const path = require('path');
const hash = require('hash-sum');
const descriptorCache = new Map();
function vue() {
<span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line"> let root;
</span><span class="token prefix unchanged"> </span><span class="token line"> return {
</span><span class="token prefix unchanged"> </span><span class="token line">   name: 'vue',
</span><span class="token prefix unchanged"> </span><span class="token line">   config(config) {
</span><span class="token prefix unchanged"> </span><span class="token line">     root = config.root;
</span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">     return {
</span><span class="token prefix inserted">+</span><span class="token line">       define: {
</span><span class="token prefix inserted">+</span><span class="token line">         __VUE_OPTIONS_API__: true,
</span><span class="token prefix inserted">+</span><span class="token line">         __VUE_PROD_DEVTOOLS__: false
</span><span class="token prefix inserted">+</span><span class="token line">       }
</span><span class="token prefix inserted">+</span><span class="token line">     }
</span></span><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">   },
</span><span class="token prefix unchanged"> </span><span class="token line">   async load(id) {
</span><span class="token prefix unchanged"> </span><span class="token line">     const { filename, query } = parseVueRequest(id);
</span><span class="token prefix unchanged"> </span><span class="token line">     if (query.has('vue')) {
</span><span class="token prefix unchanged"> </span><span class="token line">       const descriptor = await getDescriptor(filename, root);
</span><span class="token prefix unchanged"> </span><span class="token line">       if (query.get('type') === 'style') {
</span><span class="token prefix unchanged"> </span><span class="token line">         let block = descriptor.styles[Number(query.get('index'))];
</span><span class="token prefix unchanged"> </span><span class="token line">         if (block) {
</span><span class="token prefix unchanged"> </span><span class="token line">           return { code: block.content };
</span><span class="token prefix unchanged"> </span><span class="token line">         }
</span><span class="token prefix unchanged"> </span><span class="token line">       }
</span><span class="token prefix unchanged"> </span><span class="token line">     }
</span><span class="token prefix unchanged"> </span><span class="token line">   },
</span><span class="token prefix unchanged"> </span><span class="token line">   async transform(code, id) {
</span><span class="token prefix unchanged"> </span><span class="token line">     const { filename, query } = parseVueRequest(id);
</span><span class="token prefix unchanged"> </span><span class="token line">     if (filename.endsWith('.vue')) {
</span><span class="token prefix unchanged"> </span><span class="token line">       if (query.get('type') === 'style') {
</span><span class="token prefix unchanged"> </span><span class="token line">         const descriptor = await getDescriptor(filename, root);
</span><span class="token prefix unchanged"> </span><span class="token line">         let result = await transformStyle(code, descriptor, query.get('index'));
</span><span class="token prefix unchanged"> </span><span class="token line">         return result;
</span><span class="token prefix unchanged"> </span><span class="token line">       } else {
</span><span class="token prefix unchanged"> </span><span class="token line">         let result = await transformMain(code, filename);
</span><span class="token prefix unchanged"> </span><span class="token line">         return result;
</span><span class="token prefix unchanged"> </span><span class="token line">       }
</span><span class="token prefix unchanged"> </span><span class="token line">     }
</span><span class="token prefix unchanged"> </span><span class="token line">     return null;
</span><span class="token prefix unchanged"> </span><span class="token line">   }
</span><span class="token prefix unchanged"> </span><span class="token line"> }
</span></span>}
async function transformStyle(code, descriptor, index) {
<span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line"> const block = descriptor.styles[index];
</span><span class="token prefix unchanged"> </span><span class="token line"> //如果是CSS，其实翻译之后和翻译之前内容是一样的，最终返回的JS靠packages\vite\src\node\plugins\css.ts
</span><span class="token prefix unchanged"> </span><span class="token line"> const result = await compileStyleAsync({
</span><span class="token prefix unchanged"> </span><span class="token line">   filename: descriptor.filename,
</span><span class="token prefix unchanged"> </span><span class="token line">   source: code,
</span><span class="token prefix unchanged"> </span><span class="token line">   id: `data-v-${descriptor.id}`,//必须传递，不然报错
</span><span class="token prefix unchanged"> </span><span class="token line">   scoped: block.scoped
</span><span class="token prefix unchanged"> </span><span class="token line"> });
</span><span class="token prefix unchanged"> </span><span class="token line"> let styleCode = result.code;
</span><span class="token prefix unchanged"> </span><span class="token line"> const injectCode =
</span><span class="token prefix unchanged"> </span><span class="token line">   `\nvar  style = document.createElement('style');` +
</span><span class="token prefix unchanged"> </span><span class="token line">   `\nstyle.innerHTML = ${JSON.stringify(styleCode)};` +
</span><span class="token prefix unchanged"> </span><span class="token line">   `\ndocument.head.appendChild(style);`
</span><span class="token prefix unchanged"> </span><span class="token line"> return {
</span><span class="token prefix unchanged"> </span><span class="token line">   code: injectCode
</span><span class="token prefix unchanged"> </span><span class="token line"> };
</span></span>}
async function getDescriptor(filename, root) {
<span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line"> let descriptor = descriptorCache.get(filename);
</span><span class="token prefix unchanged"> </span><span class="token line"> if (descriptor) return descriptor;
</span><span class="token prefix unchanged"> </span><span class="token line"> const content = await fs.promises.readFile(filename, 'utf8');
</span><span class="token prefix unchanged"> </span><span class="token line"> const result = parse(content, { filename });
</span><span class="token prefix unchanged"> </span><span class="token line"> descriptor = result.descriptor;
</span><span class="token prefix unchanged"> </span><span class="token line"> descriptor.id = hash(path.relative(root, filename));
</span><span class="token prefix unchanged"> </span><span class="token line"> descriptorCache.set(filename, descriptor);
</span><span class="token prefix unchanged"> </span><span class="token line"> return descriptor;
</span></span>}
async function transformMain(source, filename) {
<span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line"> const { descriptor } = parse(source, { filename });
</span><span class="token prefix unchanged"> </span><span class="token line"> const scriptCode = genScriptCode(descriptor, filename)
</span><span class="token prefix unchanged"> </span><span class="token line"> const templateCode = genTemplateCode(descriptor, filename);
</span><span class="token prefix unchanged"> </span><span class="token line"> const stylesCode = genStyleCode(descriptor, filename);
</span><span class="token prefix unchanged"> </span><span class="token line"> let resolvedCode = [
</span><span class="token prefix unchanged"> </span><span class="token line">   stylesCode,
</span><span class="token prefix unchanged"> </span><span class="token line">   templateCode,
</span><span class="token prefix unchanged"> </span><span class="token line">   scriptCode,
</span><span class="token prefix unchanged"> </span><span class="token line">   `_sfc_main['render'] = render`,
</span><span class="token prefix unchanged"> </span><span class="token line">   `export default _sfc_main`
</span><span class="token prefix unchanged"> </span><span class="token line"> ].join('\n');
</span><span class="token prefix unchanged"> </span><span class="token line"> return { code: resolvedCode }
</span></span>}
function genStyleCode(descriptor, filename) {
<span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line"> let styleCode = '';
</span><span class="token prefix unchanged"> </span><span class="token line"> if (descriptor.styles.length) {
</span><span class="token prefix unchanged"> </span><span class="token line">   descriptor.styles.forEach((style, index) =&gt; {
</span><span class="token prefix unchanged"> </span><span class="token line">     const query = `?vue&amp;type=style&amp;index=${index}&amp;lang=css`;
</span><span class="token prefix unchanged"> </span><span class="token line">     const styleRequest = (filename + query).replace(/\\/g, '/');
</span><span class="token prefix unchanged"> </span><span class="token line">     styleCode += `\nimport ${JSON.stringify(styleRequest)}`;
</span><span class="token prefix unchanged"> </span><span class="token line">   });
</span><span class="token prefix unchanged"> </span><span class="token line">   return styleCode;
</span><span class="token prefix unchanged"> </span><span class="token line"> }
</span></span>}
function genScriptCode(descriptor, id) {
<span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line"> let scriptCode = ''
</span><span class="token prefix unchanged"> </span><span class="token line"> let script = compileScript(descriptor, { id });
</span><span class="token prefix unchanged"> </span><span class="token line"> if (!script.lang) {
</span><span class="token prefix unchanged"> </span><span class="token line">   scriptCode = rewriteDefault(
</span><span class="token prefix unchanged"> </span><span class="token line">     script.content,
</span><span class="token prefix unchanged"> </span><span class="token line">     '_sfc_main',
</span><span class="token prefix unchanged"> </span><span class="token line">   )
</span><span class="token prefix unchanged"> </span><span class="token line"> }
</span><span class="token prefix unchanged"> </span><span class="token line"> return scriptCode;
</span></span>}
function genTemplateCode(descriptor, id) {
<span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line"> let content = descriptor.template.content;
</span><span class="token prefix unchanged"> </span><span class="token line"> const result = compileTemplate({ source: content, id });
</span><span class="token prefix unchanged"> </span><span class="token line"> return result.code;
</span></span>}
function parseVueRequest(id) {
<span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line"> const [filename, querystring = ''] = id.split('?');
</span><span class="token prefix unchanged"> </span><span class="token line"> let query = new URLSearchParams(querystring);
</span><span class="token prefix unchanged"> </span><span class="token line"> return {
</span><span class="token prefix unchanged"> </span><span class="token line">   filename, query
</span><span class="token prefix unchanged"> </span><span class="token line"> };
</span></span>}
module.exports = vue;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br></div></div><h2 id="_11-支持hmr"><a href="#_11-支持hmr" class="header-anchor">#</a> 11.支持HMR</h2> <h3 id="_11-1-server-index-js"><a href="#_11-1-server-index-js" class="header-anchor">#</a> 11.1 server\index.js</h3> <p>lib\server\index.js</p> <div class="language-diff line-numbers-mode"><pre class="language-diff"><code>const connect = require('connect');
const http = require('http');
const serveStaticMiddleware = require('./middlewares/static');
const resolveConfig = require('../config');
const { createOptimizeDepsRun } = require('../optimizer');
const transformMiddleware = require('./middlewares/transform');
const { createPluginContainer } = require('./pluginContainer');
<span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">const { handleHMRUpdate } = require('./hmr');
</span><span class="token prefix inserted">+</span><span class="token line">const { createWebSocketServer } = require('./ws');
</span><span class="token prefix inserted">+</span><span class="token line">const { normalizePath } = require('../utils');
</span><span class="token prefix inserted">+</span><span class="token line">const chokidar = require('chokidar');
</span><span class="token prefix inserted">+</span><span class="token line">const { ModuleGraph } = require('./moduleGraph')
</span><span class="token prefix inserted">+</span><span class="token line">const path = require('path');
</span></span>async function createServer() {
<span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line"> const config = await resolveConfig();
</span><span class="token prefix unchanged"> </span><span class="token line"> const middlewares = connect();
</span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line"> const httpServer = require('http').createServer(middlewares)
</span><span class="token prefix inserted">+</span><span class="token line"> const ws = createWebSocketServer(httpServer, config)
</span><span class="token prefix inserted">+</span><span class="token line"> const watcher = chokidar.watch(path.resolve(config.root), {
</span><span class="token prefix inserted">+</span><span class="token line">   ignored: [
</span><span class="token prefix inserted">+</span><span class="token line">     '**/node_modules/**',
</span><span class="token prefix inserted">+</span><span class="token line">     '**/.git/**'
</span><span class="token prefix inserted">+</span><span class="token line">   ]
</span><span class="token prefix inserted">+</span><span class="token line"> });
</span><span class="token prefix inserted">+</span><span class="token line"> const moduleGraph = new ModuleGraph((url) =&gt;
</span><span class="token prefix inserted">+</span><span class="token line">   pluginContainer.resolveId(url)
</span><span class="token prefix inserted">+</span><span class="token line"> )
</span><span class="token prefix inserted">+</span><span class="token line"> const pluginContainer = await createPluginContainer(config)
</span></span><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line"> const server = {
</span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">   config,
</span><span class="token prefix inserted">+</span><span class="token line">   ws,
</span><span class="token prefix inserted">+</span><span class="token line">   watcher,
</span><span class="token prefix inserted">+</span><span class="token line">   moduleGraph,
</span><span class="token prefix inserted">+</span><span class="token line">   httpServer,
</span></span><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">   pluginContainer,
</span><span class="token prefix unchanged"> </span><span class="token line">   async listen(port) {
</span><span class="token prefix unchanged"> </span><span class="token line">     await runOptimize(config, server)
</span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">     httpServer.listen(port, async () =&gt; {
</span></span><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">       console.log(`server running at http://localhost:${port}`);
</span><span class="token prefix unchanged"> </span><span class="token line">     });
</span><span class="token prefix unchanged"> </span><span class="token line">   }
</span><span class="token prefix unchanged"> </span><span class="token line"> }
</span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line"> watcher.on('change', async (file) =&gt; {
</span><span class="token prefix inserted">+</span><span class="token line">   file = normalizePath(file)
</span><span class="token prefix inserted">+</span><span class="token line">   await handleHMRUpdate(file, server)
</span><span class="token prefix inserted">+</span><span class="token line"> })
</span></span><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line"> for (const plugin of config.plugins) {
</span><span class="token prefix unchanged"> </span><span class="token line">   if (plugin.configureServer) {
</span><span class="token prefix unchanged"> </span><span class="token line">     await plugin.configureServer(server)
</span><span class="token prefix unchanged"> </span><span class="token line">   }
</span><span class="token prefix unchanged"> </span><span class="token line"> }
</span><span class="token prefix unchanged"> </span><span class="token line"> middlewares.use(transformMiddleware(server))
</span><span class="token prefix unchanged"> </span><span class="token line"> middlewares.use(serveStaticMiddleware(config));
</span><span class="token prefix unchanged"> </span><span class="token line"> return server;
</span></span>}
async function runOptimize(config, server) {
<span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line"> const optimizeDeps = await createOptimizeDepsRun(config);
</span><span class="token prefix unchanged"> </span><span class="token line"> server._optimizeDepsMetadata = optimizeDeps.metadata
</span></span>}
exports.createServer = createServer;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br></div></div><h3 id="_11-2-lib-server-ws-js"><a href="#_11-2-lib-server-ws-js" class="header-anchor">#</a> 11.2 lib\server\ws.js</h3> <p>lib\server\ws.js</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token punctuation">{</span> WebSocketServer <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'ws'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token constant">HMR_HEADER</span> <span class="token operator">=</span> <span class="token string">'vite-hmr'</span>
<span class="token keyword">function</span> <span class="token function">createWebSocketServer</span><span class="token punctuation">(</span><span class="token parameter">httpServer</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> wss <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WebSocketServer</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">noServer</span><span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  httpServer<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'upgrade'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> socket<span class="token punctuation">,</span> head</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>req<span class="token punctuation">.</span>headers<span class="token punctuation">[</span><span class="token string">'sec-websocket-protocol'</span><span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token constant">HMR_HEADER</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      wss<span class="token punctuation">.</span><span class="token function">handleUpgrade</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> socket<span class="token punctuation">,</span> head<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">ws</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        wss<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">'connection'</span><span class="token punctuation">,</span> ws<span class="token punctuation">,</span> req<span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  wss<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'connection'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">socket</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    socket<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'connected'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">on</span><span class="token operator">:</span> wss<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>wss<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token literal-property property">off</span><span class="token operator">:</span> wss<span class="token punctuation">.</span><span class="token function">off</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>wss<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">send</span><span class="token punctuation">(</span><span class="token parameter">payload</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> stringified <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>payload<span class="token punctuation">)</span>
      wss<span class="token punctuation">.</span>clients<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">client</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>client<span class="token punctuation">.</span>readyState <span class="token operator">===</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          client<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>stringified<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
exports<span class="token punctuation">.</span>createWebSocketServer <span class="token operator">=</span> createWebSocketServer<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br></div></div><h3 id="_11-3-hmr-js"><a href="#_11-3-hmr-js" class="header-anchor">#</a> 11.3 hmr.js</h3> <p>lib\server\hmr.js</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> LexerState <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">inCall</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
  <span class="token literal-property property">inSingleQuoteString</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
  <span class="token literal-property property">inTemplateString</span><span class="token operator">:</span> <span class="token number">2</span>
<span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">getShortName</span><span class="token punctuation">(</span><span class="token parameter">file<span class="token punctuation">,</span> root</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> file<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span>root <span class="token operator">+</span> <span class="token string">'/'</span><span class="token punctuation">)</span> <span class="token operator">?</span> path<span class="token punctuation">.</span>posix<span class="token punctuation">.</span><span class="token function">relative</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> file<span class="token punctuation">)</span> <span class="token operator">:</span> file
<span class="token punctuation">}</span>
<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">handleHMRUpdate</span><span class="token punctuation">(</span><span class="token parameter">file<span class="token punctuation">,</span> server</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> config<span class="token punctuation">,</span> moduleGraph <span class="token punctuation">}</span> <span class="token operator">=</span> server
  <span class="token keyword">const</span> shortFile <span class="token operator">=</span> <span class="token function">getShortName</span><span class="token punctuation">(</span>file<span class="token punctuation">,</span> config<span class="token punctuation">.</span>root<span class="token punctuation">)</span>
  <span class="token keyword">const</span> modules <span class="token operator">=</span> moduleGraph<span class="token punctuation">.</span><span class="token function">getModulesByFile</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token function">updateModules</span><span class="token punctuation">(</span>shortFile<span class="token punctuation">,</span> modules<span class="token punctuation">,</span> server<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">updateModules</span><span class="token punctuation">(</span><span class="token parameter">file<span class="token punctuation">,</span> modules<span class="token punctuation">,</span> <span class="token punctuation">{</span> ws <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> updates <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> mod <span class="token keyword">of</span> modules<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> boundaries <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token function">propagateUpdate</span><span class="token punctuation">(</span>mod<span class="token punctuation">,</span> boundaries<span class="token punctuation">)</span>
    updates<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>
      <span class="token operator">...</span><span class="token punctuation">[</span><span class="token operator">...</span>boundaries<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> boundary<span class="token punctuation">,</span> acceptedVia <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token punctuation">{</span>
        <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>boundary<span class="token punctuation">.</span>type<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">-update</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
        <span class="token literal-property property">path</span><span class="token operator">:</span> boundary<span class="token punctuation">.</span>url<span class="token punctuation">,</span>
        <span class="token literal-property property">acceptedPath</span><span class="token operator">:</span> acceptedVia<span class="token punctuation">.</span>url
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  ws<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'update'</span><span class="token punctuation">,</span>
    updates
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">propagateUpdate</span><span class="token punctuation">(</span><span class="token parameter">node<span class="token punctuation">,</span> boundaries</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>node<span class="token punctuation">.</span>importers<span class="token punctuation">.</span>size<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> importer <span class="token keyword">of</span> node<span class="token punctuation">.</span>importers<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>importer<span class="token punctuation">.</span>acceptedHmrDeps<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      boundaries<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        <span class="token literal-property property">boundary</span><span class="token operator">:</span> importer<span class="token punctuation">,</span>
        <span class="token literal-property property">acceptedVia</span><span class="token operator">:</span> node
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token keyword">continue</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">lexAcceptedHmrDeps</span><span class="token punctuation">(</span><span class="token parameter">code<span class="token punctuation">,</span> start<span class="token punctuation">,</span> urls</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> state <span class="token operator">=</span> LexerState<span class="token punctuation">.</span>inCall
  <span class="token keyword">let</span> prevState <span class="token operator">=</span> LexerState<span class="token punctuation">.</span>inCall
  <span class="token keyword">let</span> currentDep <span class="token operator">=</span> <span class="token string">''</span>
  <span class="token keyword">function</span> <span class="token function">addDep</span><span class="token punctuation">(</span><span class="token parameter">index</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    urls<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      <span class="token literal-property property">url</span><span class="token operator">:</span> currentDep<span class="token punctuation">,</span>
      <span class="token literal-property property">start</span><span class="token operator">:</span> index <span class="token operator">-</span> currentDep<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span>
      <span class="token literal-property property">end</span><span class="token operator">:</span> index <span class="token operator">+</span> <span class="token number">1</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    currentDep <span class="token operator">=</span> <span class="token string">''</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> start<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> code<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> char <span class="token operator">=</span> code<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span>
    <span class="token keyword">switch</span> <span class="token punctuation">(</span>state<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">case</span> LexerState<span class="token punctuation">.</span>inCall<span class="token operator">:</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>char <span class="token operator">===</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">'</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          prevState <span class="token operator">=</span> state
          state <span class="token operator">=</span> LexerState<span class="token punctuation">.</span>inSingleQuoteString
        <span class="token punctuation">}</span>
        <span class="token keyword">break</span>
      <span class="token keyword">case</span> LexerState<span class="token punctuation">.</span>inSingleQuoteString<span class="token operator">:</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>char <span class="token operator">===</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">'</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token function">addDep</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span>
          <span class="token keyword">return</span> <span class="token boolean">false</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
          currentDep <span class="token operator">+=</span> char
        <span class="token punctuation">}</span>
        <span class="token keyword">break</span>
      <span class="token keyword">default</span><span class="token operator">:</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token boolean">false</span>
<span class="token punctuation">}</span>
exports<span class="token punctuation">.</span>handleHMRUpdate <span class="token operator">=</span> handleHMRUpdate<span class="token punctuation">;</span>
exports<span class="token punctuation">.</span>updateModules <span class="token operator">=</span> updateModules<span class="token punctuation">;</span>
exports<span class="token punctuation">.</span>lexAcceptedHmrDeps <span class="token operator">=</span> lexAcceptedHmrDeps<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br></div></div><h3 id="_11-4-transformrequest-js"><a href="#_11-4-transformrequest-js" class="header-anchor">#</a> 11.4 transformRequest.js</h3> <p>lib\server\transformRequest.js</p> <div class="language-diff line-numbers-mode"><pre class="language-diff"><code>const fs = require('fs-extra');
async function transformRequest(url, server) {
<span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line"> const { pluginContainer } = server
</span><span class="token prefix unchanged"> </span><span class="token line"> const { id } = await pluginContainer.resolveId(url);
</span><span class="token prefix unchanged"> </span><span class="token line"> const loadResult = await pluginContainer.load(id)
</span><span class="token prefix unchanged"> </span><span class="token line"> let code;
</span><span class="token prefix unchanged"> </span><span class="token line"> if (loadResult) {
</span><span class="token prefix unchanged"> </span><span class="token line">   code = loadResult.code;;
</span><span class="token prefix unchanged"> </span><span class="token line"> } else {
</span><span class="token prefix unchanged"> </span><span class="token line">   code = await fs.readFile(id, 'utf-8')
</span><span class="token prefix unchanged"> </span><span class="token line"> }
</span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line"> await server.moduleGraph.ensureEntryFromUrl(url)
</span></span><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line"> const transformResult = await pluginContainer.transform(code, id)
</span><span class="token prefix unchanged"> </span><span class="token line"> return transformResult;
</span></span>}
module.exports = transformRequest;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><h3 id="_11-5-modulegraph-js"><a href="#_11-5-modulegraph-js" class="header-anchor">#</a> 11.5 moduleGraph.js</h3> <p>lib\server\moduleGraph.js</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">class</span> <span class="token class-name">ModuleNode</span> <span class="token punctuation">{</span>
  importers <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  acceptedHmrDeps <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">url</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>url <span class="token operator">=</span> url
    <span class="token keyword">this</span><span class="token punctuation">.</span>type <span class="token operator">=</span> <span class="token string">'js'</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">class</span> <span class="token class-name">ModuleGraph</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">resolveId</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>resolveId <span class="token operator">=</span> resolveId<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  fileToModulesMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  urlToModuleMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  idToModuleMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

  <span class="token function">getModulesByFile</span><span class="token punctuation">(</span><span class="token parameter">file</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>fileToModulesMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token function">getModuleById</span><span class="token punctuation">(</span><span class="token parameter">id</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>idToModuleMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">async</span> <span class="token function">ensureEntryFromUrl</span><span class="token punctuation">(</span><span class="token parameter">rawUrl</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">[</span>url<span class="token punctuation">,</span> resolvedId<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">resolveUrl</span><span class="token punctuation">(</span>rawUrl<span class="token punctuation">)</span>
    <span class="token keyword">let</span> mod <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>urlToModuleMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mod<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      mod <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ModuleNode</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>urlToModuleMap<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> mod<span class="token punctuation">)</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>idToModuleMap<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>resolvedId<span class="token punctuation">,</span> mod<span class="token punctuation">)</span>
      <span class="token keyword">const</span> file <span class="token operator">=</span> <span class="token punctuation">(</span>mod<span class="token punctuation">.</span>file <span class="token operator">=</span> resolvedId<span class="token punctuation">)</span>
      <span class="token keyword">let</span> fileMappedModules <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>fileToModulesMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>fileMappedModules<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        fileMappedModules <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>fileToModulesMap<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>file<span class="token punctuation">,</span> fileMappedModules<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      fileMappedModules<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>mod<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> mod<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">async</span> <span class="token function">resolveUrl</span><span class="token punctuation">(</span><span class="token parameter">url</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> resolved <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">resolveId</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span>
    <span class="token keyword">const</span> resolvedId <span class="token operator">=</span> resolved<span class="token punctuation">.</span>id <span class="token operator">||</span> url
    <span class="token keyword">return</span> <span class="token punctuation">[</span>url<span class="token punctuation">,</span> resolvedId<span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">async</span> <span class="token function">updateModuleInfo</span><span class="token punctuation">(</span><span class="token parameter">mod<span class="token punctuation">,</span> importedModules<span class="token punctuation">,</span> acceptedModules</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> imported <span class="token keyword">of</span> importedModules<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> dep <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">ensureEntryFromUrl</span><span class="token punctuation">(</span>imported<span class="token punctuation">)</span>
      dep<span class="token punctuation">.</span>importers<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>mod<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">const</span> deps <span class="token operator">=</span> <span class="token punctuation">(</span>mod<span class="token punctuation">.</span>acceptedHmrDeps <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> accepted <span class="token keyword">of</span> acceptedModules<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> dep <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">ensureEntryFromUrl</span><span class="token punctuation">(</span>accepted<span class="token punctuation">)</span>
      deps<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>dep<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
exports<span class="token punctuation">.</span>ModuleGraph <span class="token operator">=</span> ModuleGraph<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br></div></div><h3 id="_11-6-importanalysis-js"><a href="#_11-6-importanalysis-js" class="header-anchor">#</a> 11.6 importAnalysis.js</h3> <p>lib\plugins\importAnalysis.js</p> <div class="language-diff line-numbers-mode"><pre class="language-diff"><code>const { init, parse } = require('es-module-lexer')
const MagicString = require('magic-string');
<span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">const { lexAcceptedHmrDeps } = require('../server/hmr');
</span><span class="token prefix inserted">+</span><span class="token line">const path = require('path');
</span></span>function importAnalysisPlugin(config) {
<span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line"> const { root } = config
</span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line"> let server
</span></span><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line"> return {
</span><span class="token prefix unchanged"> </span><span class="token line">   name: 'vite:import-analysis',
</span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">   configureServer(_server) {
</span><span class="token prefix inserted">+</span><span class="token line">     server = _server
</span><span class="token prefix inserted">+</span><span class="token line">   },
</span></span><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">   async transform(source, importer) {
</span><span class="token prefix unchanged"> </span><span class="token line">     await init
</span><span class="token prefix unchanged"> </span><span class="token line">     let imports = parse(source)[0]
</span><span class="token prefix unchanged"> </span><span class="token line">     if (!imports.length) {
</span><span class="token prefix unchanged"> </span><span class="token line">       return source
</span><span class="token prefix unchanged"> </span><span class="token line">     }
</span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">     const { moduleGraph } = server
</span><span class="token prefix inserted">+</span><span class="token line">     const importerModule = moduleGraph.getModuleById(importer)
</span><span class="token prefix inserted">+</span><span class="token line">     const importedUrls = new Set()
</span><span class="token prefix inserted">+</span><span class="token line">     const acceptedUrls = new Set()
</span></span><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">     let ms = new MagicString(source);
</span><span class="token prefix unchanged"> </span><span class="token line">     const normalizeUrl = async (url) =&gt; {
</span><span class="token prefix unchanged"> </span><span class="token line">       const resolved = await this.resolve(url, importer)
</span><span class="token prefix unchanged"> </span><span class="token line">       if (resolved.id.startsWith(root + '/')) {
</span><span class="token prefix unchanged"> </span><span class="token line">         url = resolved.id.slice(root.length)
</span><span class="token prefix unchanged"> </span><span class="token line">       }
</span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">       await moduleGraph.ensureEntryFromUrl(url)
</span></span><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">       return url;
</span><span class="token prefix unchanged"> </span><span class="token line">     }
</span><span class="token prefix unchanged"> </span><span class="token line">     for (let index = 0; index &lt; imports.length; index++) {
</span><span class="token prefix unchanged"> </span><span class="token line">       const { s: start, e: end, n: specifier } = imports[index]
</span><span class="token prefix unchanged"> </span><span class="token line">       const rawUrl = source.slice(start, end)
</span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">       if (rawUrl === 'import.meta') {
</span><span class="token prefix inserted">+</span><span class="token line">         const prop = source.slice(end, end + 4)
</span><span class="token prefix inserted">+</span><span class="token line">         if (prop === '.hot') {
</span><span class="token prefix inserted">+</span><span class="token line">           if (source.slice(end + 4, end + 11) === '.accept') {
</span><span class="token prefix inserted">+</span><span class="token line">             lexAcceptedHmrDeps(source, source.indexOf('(', end + 11) + 1, acceptedUrls)
</span><span class="token prefix inserted">+</span><span class="token line">           }
</span><span class="token prefix inserted">+</span><span class="token line">         }
</span><span class="token prefix inserted">+</span><span class="token line">       }
</span></span><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">       if (specifier) {
</span><span class="token prefix unchanged"> </span><span class="token line">         const normalizedUrl = await normalizeUrl(specifier)
</span><span class="token prefix unchanged"> </span><span class="token line">         if (normalizedUrl !== specifier) {
</span><span class="token prefix unchanged"> </span><span class="token line">           ms.overwrite(start, end, normalizedUrl)
</span><span class="token prefix unchanged"> </span><span class="token line">         }
</span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">         importedUrls.add(normalizedUrl)
</span></span><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">       }
</span><span class="token prefix unchanged"> </span><span class="token line">     }
</span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">     const normalizedAcceptedUrls = new Set()
</span><span class="token prefix inserted">+</span><span class="token line">     const toAbsoluteUrl = (url) =&gt;
</span><span class="token prefix inserted">+</span><span class="token line">       path.posix.resolve(path.posix.dirname(importerModule.url), url)
</span><span class="token prefix inserted">+</span><span class="token line">     for (const { url, start, end } of acceptedUrls) {
</span><span class="token prefix inserted">+</span><span class="token line">       const [normalized] = await moduleGraph.resolveUrl(toAbsoluteUrl(url),)
</span><span class="token prefix inserted">+</span><span class="token line">       normalizedAcceptedUrls.add(normalized)
</span><span class="token prefix inserted">+</span><span class="token line">       ms.overwrite(start, end, JSON.stringify(normalized))
</span><span class="token prefix inserted">+</span><span class="token line">     }
</span><span class="token prefix inserted">+</span><span class="token line">     await moduleGraph.updateModuleInfo(
</span><span class="token prefix inserted">+</span><span class="token line">       importerModule,
</span><span class="token prefix inserted">+</span><span class="token line">       importedUrls,
</span><span class="token prefix inserted">+</span><span class="token line">       normalizedAcceptedUrls
</span><span class="token prefix inserted">+</span><span class="token line">     )
</span></span><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">     return ms.toString()
</span><span class="token prefix unchanged"> </span><span class="token line">   }
</span><span class="token prefix unchanged"> </span><span class="token line"> }
</span></span>}
module.exports = importAnalysisPlugin;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br></div></div><h3 id="_11-7-index-html"><a href="#_11-7-index-html" class="header-anchor">#</a> 11.7 index.html</h3> <p>index.html</p> <div class="language-html line-numbers-mode"><pre class="language-html"><code><span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">html</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>en<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>UTF-8<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">http-equiv</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>X-UA-Compatible<span class="token punctuation">&quot;</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>IE=edge<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>viewport<span class="token punctuation">&quot;</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>width=device-width, initial-scale=1.0<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">&gt;</span></span>Document<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>app<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>/src/main.js<span class="token punctuation">&quot;</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>module<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>/src/client.js<span class="token punctuation">&quot;</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>module<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><h3 id="_11-8-src-main-js"><a href="#_11-8-src-main-js" class="header-anchor">#</a> 11.8 src\main.js</h3> <p>src\main.js</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> render <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./render.js'</span><span class="token punctuation">;</span>
<span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
window<span class="token punctuation">.</span>hotModulesMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">var</span> ownerPath <span class="token operator">=</span> <span class="token string">&quot;/src/main.js&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span><span class="token punctuation">.</span>meta<span class="token punctuation">.</span>hot <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token function">accept</span><span class="token punctuation">(</span><span class="token parameter">deps<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">acceptDeps</span><span class="token punctuation">(</span>deps<span class="token punctuation">,</span> callback<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">acceptDeps</span><span class="token punctuation">(</span><span class="token parameter">deps<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> mod <span class="token operator">=</span> hotModulesMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>ownerPath<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">id</span><span class="token operator">:</span> ownerPath<span class="token punctuation">,</span>
    <span class="token literal-property property">callbacks</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
  mod<span class="token punctuation">.</span>callbacks<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    deps<span class="token punctuation">,</span>
    <span class="token literal-property property">fn</span><span class="token operator">:</span> callback
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  hotModulesMap<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>ownerPath<span class="token punctuation">,</span> mod<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">import</span><span class="token punctuation">.</span>meta<span class="token punctuation">.</span>hot<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">import</span><span class="token punctuation">.</span>meta<span class="token punctuation">.</span>hot<span class="token punctuation">.</span><span class="token function">accept</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'./render.js'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">[</span>renderMod<span class="token punctuation">]</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    renderMod<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br></div></div><h3 id="_11-9-src-render-js"><a href="#_11-9-src-render-js" class="header-anchor">#</a> 11.9 src\render.js</h3> <p>src\render.js</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  app<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> <span class="token string">'title1'</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h3 id="_11-10-src-client-js"><a href="#_11-10-src-client-js" class="header-anchor">#</a> 11.10 src\client.js</h3> <p>src\client.js</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'[vite] connecting...'</span><span class="token punctuation">)</span>
<span class="token keyword">var</span> socket <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WebSocket</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">ws://</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>window<span class="token punctuation">.</span>location<span class="token punctuation">.</span>host<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> <span class="token string">'vite-hmr'</span><span class="token punctuation">)</span>
socket<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'message'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> data <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token function">handleMessage</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">handleMessage</span><span class="token punctuation">(</span><span class="token parameter">payload</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">switch</span> <span class="token punctuation">(</span>payload<span class="token punctuation">.</span>type<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">case</span> <span class="token string">'connected'</span><span class="token operator">:</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">[vite] connected.</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> <span class="token string">'update'</span><span class="token operator">:</span>
      payload<span class="token punctuation">.</span>updates<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">update</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>update<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">'js-update'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token function">fetchUpdate</span><span class="token punctuation">(</span>update<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> <span class="token string">'full-reload'</span><span class="token operator">:</span>
      location<span class="token punctuation">.</span><span class="token function">reload</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">default</span><span class="token operator">:</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">fetchUpdate</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> path<span class="token punctuation">,</span> acceptedPath <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> mod <span class="token operator">=</span> window<span class="token punctuation">.</span>hotModulesMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mod<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">const</span> moduleMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> modulesToUpdate <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token punctuation">{</span> deps <span class="token punctuation">}</span> <span class="token keyword">of</span> mod<span class="token punctuation">.</span>callbacks<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    deps<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">dep</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>acceptedPath <span class="token operator">===</span> dep<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        modulesToUpdate<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>dep<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">await</span> Promise<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span>
    Array<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>modulesToUpdate<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">dep</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> newMod <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">import</span><span class="token punctuation">(</span>dep <span class="token operator">+</span> <span class="token string">'?ts='</span> <span class="token operator">+</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      moduleMap<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>dep<span class="token punctuation">,</span> newMod<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">)</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token punctuation">{</span> deps<span class="token punctuation">,</span> fn <span class="token punctuation">}</span> <span class="token keyword">of</span> mod<span class="token punctuation">.</span>callbacks<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">fn</span><span class="token punctuation">(</span>deps<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">dep</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> moduleMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>dep<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">const</span> loggedPath <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>acceptedPath<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> via </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>path<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">[vite] hot updated: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>loggedPath<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br></div></div></div></div> <!----> <div class="page-edit"><div class="edit-link"><a href="https://github.com//sunnyxujian/edit/master/docs/03.工程化/06.vite/03.vite的核心原理.md" target="_blank" rel="noopener noreferrer">编辑</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <div class="tags"><a href="/tags/?tag=vite" title="标签">#vite</a></div> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">2022/05/22, 18:34:11</span></div></div> <div class="page-nav-wapper"><div class="page-nav-centre-wrap"><a href="/pages/56bbdc/" class="page-nav-centre page-nav-centre-prev"><div class="tooltip">esbuild介绍</div></a> <a href="/engineering/betterConsole/" class="page-nav-centre page-nav-centre-next"><div class="tooltip">手写babel插件优化打印体验</div></a></div> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/pages/56bbdc/" class="prev">esbuild介绍</a></span> <span class="next"><a href="/engineering/betterConsole/">手写babel插件优化打印体验</a>→
      </span></p></div></div></div> <div class="article-list"><div class="article-title"><a href="/archives/" class="iconfont icon-bi">最近更新</a></div> <div class="article-wrapper"><dl><dd>01</dd> <dt><a href="/pages/de22dd/"><div>😍Vue3和React都在用的函数式编程，学起来~</div></a> <span>02-03</span></dt></dl><dl><dd>02</dd> <dt><a href="/pages/29bc3b/"><div>链表</div></a> <span>11-24</span></dt></dl><dl><dd>03</dd> <dt><a href="/pages/7f20fa/"><div>基础类型</div></a> <span>11-18</span></dt></dl> <dl><dd></dd> <dt><a href="/archives/" class="more">更多文章&gt;</a></dt></dl></div></div></main></div> <div class="footer"><div class="icons"><a href="mailto:1227971544@qq.com" title="发邮件" target="_blank" class="iconfont icon-youjian"></a><a href="https://github.com/sunnyxujian" title="GitHub" target="_blank" class="iconfont icon-github"></a><a href="https://music.163.com/#/playlist?id=755597173" title="听音乐" target="_blank" class="iconfont icon-erji"></a></div> 
  Theme by
  <a>Vdoing</a> 
    | Copyright © 2020-2023
    <span>xujian | <a href="https://gitee.com/microjan/blog/LICENSE" target="_blank">MIT License</a></span></div> <div class="buttons"><div title="返回顶部" class="button blur go-to-top iconfont icon-fanhuidingbu" style="display:none;"></div> <div title="去评论" class="button blur go-to-comment iconfont icon-pinglun" style="display:none;"></div> <div title="主题模式" class="button blur theme-mode-but iconfont icon-zhuti"><ul class="select-box" style="display:none;"><li class="iconfont icon-zidong">跟随系统</li><li class="iconfont icon-rijianmoshi">浅色模式</li><li class="iconfont icon-yejianmoshi">深色模式</li><li class="iconfont icon-yuedu">阅读模式</li></ul></div></div> <div class="body-bg" style="background:url() center center / cover no-repeat;opacity:0.5;"></div> <!----> <!----></div><div class="global-ui"><div></div><div class="cat-container" data-v-a13867c0><canvas id="vuepress-cat" width="280" height="250" class="live2d" data-v-a13867c0></canvas></div><!----><div class="RibbonAnimation"></div></div></div>
    <script src="/assets/js/app.d76a6140.js" defer></script><script src="/assets/js/3.724bf448.js" defer></script><script src="/assets/js/5.f79ce4cb.js" defer></script><script src="/assets/js/87.66be9b4e.js" defer></script>
  </body>
</html>